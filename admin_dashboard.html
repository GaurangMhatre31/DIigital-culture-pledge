{% extends "base.html" %}

{% block head %}
<style>
.text-white-75 {
    color: rgba(255, 255, 255, 0.9) !important;
}
.premium-kpi-card .text-white {
    color: #ffffff !important;
}
.premium-kpi-card h2 {
    text-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.premium-kpi-card p, .premium-kpi-card small {
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
</style>
{% endblock %}

{% block content %}
<!-- Premium Enterprise Header -->
<div class="premium-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: -1rem -1rem 2rem -1rem; padding: 2.5rem 1.5rem; position: relative; z-index: 10;">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-3 fw-bold text-white" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    <i class="fas fa-chart-line me-3" style="color: #ffd700;"></i>
                    Executive Dashboard
                </h1>
                <p class="mb-3 text-white-50 fs-5">Digital Transformation Analytics & Management Platform</p>
                <div class="mt-3">
                    <span class="badge status-badge me-3 px-3 py-2" style="background: rgba(40, 167, 69, 0.2); color: white; border-radius: 20px; font-size: 0.95rem; font-weight: 600;">
                        <i class="fas fa-circle text-success me-2 pulse-animation" style="font-size: 10px;"></i>
                        System Online
                    </span>
                    <span class="badge status-badge px-3 py-2" style="background: rgba(255, 193, 7, 0.2); color: white; border-radius: 20px; font-size: 0.95rem; font-weight: 600;">
                        <i class="fas fa-sync-alt me-2 text-warning" style="animation: spin 3s linear infinite;"></i>
                        Real-time Data
                    </span>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="btn-group shadow-lg mb-3" role="group">
                    <button class="btn btn-light btn-sm fw-semibold" onclick="exportData('excel')" title="Export to Excel">
                        <i class="fas fa-file-excel text-success me-2"></i>Excel
                    </button>
                    <button class="btn btn-light btn-sm fw-semibold" onclick="exportData('csv')" title="Export to CSV">
                        <i class="fas fa-file-csv text-info me-2"></i>CSV
                    </button>
                    <button class="btn btn-warning btn-sm fw-semibold" onclick="showCohortReportModal()" title="Generate Cohort Reports">
                        <i class="fas fa-users me-2"></i>Reports
                    </button>
                </div>
                <div class="text-white-50">
                    <small>Last updated: <span id="lastUpdate" class="text-white fw-semibold">Just now</span></small>
                </div>
            </div>
        </div>
    </div>
</div>
        
<!-- Premium Navigation System -->
<div class="premium-nav-container mb-4">
    <div class="card border-0 shadow-lg">
        <div class="card-body p-0">
            <ul class="nav nav-pills nav-justified premium-nav" id="adminTabs" role="tablist" style="padding: 0.5rem;">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active premium-nav-link" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                        <div class="nav-icon-container">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <span class="nav-text">Overview</span>
                        <div class="nav-indicator"></div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link premium-nav-link" id="participants-tab" data-bs-toggle="tab" data-bs-target="#participants" type="button" role="tab">
                        <div class="nav-icon-container">
                            <i class="fas fa-users"></i>
                        </div>
                        <span class="nav-text">Participants</span>
                        <div class="nav-indicator"></div>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link premium-nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                        <div class="nav-icon-container">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <span class="nav-text">Analytics</span>
                        <div class="nav-indicator"></div>
                    </button>
                </li>

                <li class="nav-item" role="presentation">
                    <button class="nav-link premium-nav-link" id="impact-analysis-tab" data-bs-toggle="tab" data-bs-target="#impact-analysis" type="button" role="tab">
                        <div class="nav-icon-container">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <span class="nav-text">Impact Analysis</span>
                        <div class="nav-indicator"></div>
                    </button>
                </li>

                <li class="nav-item" role="presentation">
                    <button class="nav-link premium-nav-link" id="survey-builder-tab" data-bs-toggle="tab" data-bs-target="#survey-builder" type="button" role="tab">
                        <div class="nav-icon-container">
                            <i class="fas fa-tools"></i>
                        </div>
                        <span class="nav-text">Builder</span>
                        <div class="nav-indicator"></div>
                    </button>
                </li>

                <li class="nav-item" role="presentation">
                    <button class="nav-link premium-nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                        <div class="nav-icon-container">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <span class="nav-text">Settings</span>
                        <div class="nav-indicator"></div>
                    </button>
                </li>
            </ul>
        </div>
    </div>
</div>

<div class="tab-content" id="adminTabContent">

<!-- Overview Tab -->
<div class="tab-pane fade show active" id="overview" role="tabpanel">
    <!-- Premium KPI Dashboard -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-0 shadow-lg premium-kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-center py-4 text-white">
                    <div class="premium-icon-wrapper mb-3">
                        <i class="fas fa-users fa-2x text-white"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-2 text-white">{{ total_pledges }}</h2>
                    <p class="mb-0 small text-uppercase fw-semibold text-white">Total Participants</p>
                    <div class="mt-2">
                        <small class="text-white-75">Active enrollees</small>
                    </div>
                </div>
                <div class="card-footer bg-white bg-opacity-20 border-0 py-2">
                    <div class="d-flex justify-content-between align-items-center text-white">
                        <small class="text-white-75">Status</small>
                        <small class="text-white"><i class="fas fa-arrow-up me-1"></i>Enrolled</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-0 shadow-lg premium-kpi-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <div class="card-body text-center py-4 text-white">
                    <div class="premium-icon-wrapper mb-3">
                        <i class="fas fa-check-circle fa-2x text-white"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-2 text-white">{{ total_surveys }}</h2>
                    <p class="mb-0 small text-uppercase fw-semibold text-white">Surveys Completed</p>
                    <div class="mt-2">
                        <small class="text-white-75">Assessment submissions</small>
                    </div>
                </div>
                <div class="card-footer bg-white bg-opacity-20 border-0 py-2">
                    <div class="d-flex justify-content-between align-items-center text-white">
                        <small class="text-white-75">Progress</small>
                        <small class="text-white"><i class="fas fa-chart-line me-1"></i>{% if total_pledges > 0 %}{{ ((total_surveys / total_pledges) * 100)|round(1) }}%{% else %}0%{% endif %}</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-0 shadow-lg premium-kpi-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);">
                <div class="card-body text-center py-4 text-white">
                    <div class="premium-icon-wrapper mb-3">
                        <i class="fas fa-tasks fa-2x text-white"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-2 text-white">{{ practice_stats.total_practices|default(0) }}</h2>
                    <p class="mb-0 small text-uppercase fw-semibold text-white">Practices Logged</p>
                    <div class="mt-2">
                        <small class="text-white-75">Implementation entries</small>
                    </div>
                </div>
                <div class="card-footer bg-white bg-opacity-20 border-0 py-2">
                    <div class="d-flex justify-content-between align-items-center text-white">
                        <small class="text-white-75">Activity</small>
                        <small class="text-white"><i class="fas fa-fire me-1"></i>High</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card border-0 shadow-lg premium-kpi-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-center py-4 text-white">
                    <div class="premium-icon-wrapper mb-3">
                        <i class="fas fa-trophy fa-2x text-white"></i>
                    </div>
                    <h2 class="display-6 fw-bold mb-2 text-white">{{ practice_stats.HIGH|default(0) }}</h2>
                    <p class="mb-0 small text-uppercase fw-semibold text-white">High Impact Results</p>
                    <div class="mt-2">
                        <small class="text-white-75">Excellence indicators</small>
                    </div>
                </div>
                <div class="card-footer bg-white bg-opacity-20 border-0 py-2">
                    <div class="d-flex justify-content-between align-items-center text-white">
                        <small class="text-white-75">Quality</small>
                        <small class="text-white"><i class="fas fa-star me-1"></i>Premium</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Corporate Data Analysis -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-calendar text-secondary me-2"></i>
                        Completion Trends Analysis
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-borderless table-sm">
                            <thead>
                                <tr class="border-bottom">
                                    <th class="text-muted small">Time Period</th>
                                    <th class="text-muted small text-center">Submissions</th>
                                    <th class="text-muted small text-center">Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="small">Week 1</td>
                                    <td class="text-center small">8</td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-dark" style="width: 25%"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="small">Week 2</td>
                                    <td class="text-center small">12</td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-dark" style="width: 40%"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="small">Week 3</td>
                                    <td class="text-center small">10</td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-dark" style="width: 33%"></div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="small">Week 4</td>
                                    <td class="text-center small">3</td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-secondary" style="width: 10%"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-star text-secondary me-2"></i>
                        Impact Distribution
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-borderless table-sm">
                            <tbody>
                                <tr>
                                    <td class="text-muted small">High Impact</td>
                                    <td class="text-end">
                                        <span class="badge bg-dark">{{ practice_stats.HIGH|default(0) }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">Medium Impact</td>
                                    <td class="text-end">
                                        <span class="badge bg-secondary">{{ practice_stats.MEDIUM|default(0) }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">Low Impact</td>
                                    <td class="text-end">
                                        <span class="badge bg-light text-dark border">{{ practice_stats.LOW|default(0) }}</span>
                                    </td>
                                </tr>
                                <tr class="border-top">
                                    <td class="text-muted small fw-semibold">Total</td>
                                    <td class="text-end">
                                        <span class="badge bg-dark">{{ practice_stats.total_practices|default(0) }}</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular Practices Analysis -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-list text-secondary me-2"></i>
                        Most Popular Digital Practices
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-borderless table-sm">
                            <thead>
                                <tr class="border-bottom">
                                    <th class="text-muted small">Practice Area</th>
                                    <th class="text-muted small text-center">Frequency</th>
                                    <th class="text-muted small text-center">Category</th>
                                    <th class="text-muted small text-center">Success Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="small">Dashboard Management Implementation</td>
                                    <td class="text-center small">15</td>
                                    <td class="text-center"><span class="badge bg-dark text-white small">Weekly</span></td>
                                    <td class="text-center small">87%</td>
                                </tr>
                                <tr>
                                    <td class="small">Data-Driven Decision Making</td>
                                    <td class="text-center small">12</td>
                                    <td class="text-center"><span class="badge bg-secondary small">Monthly</span></td>
                                    <td class="text-center small">73%</td>
                                </tr>
                                <tr>
                                    <td class="small">Digital Team Routines</td>
                                    <td class="text-center small">10</td>
                                    <td class="text-center"><span class="badge bg-dark text-white small">Weekly</span></td>
                                    <td class="text-center small">92%</td>
                                </tr>
                                <tr>
                                    <td class="small">Digital Experimentation Programs</td>
                                    <td class="text-center small">8</td>
                                    <td class="text-center"><span class="badge bg-light text-dark border small">Quarterly</span></td>
                                    <td class="text-center small">68%</td>
                                </tr>
                                <tr>
                                    <td class="small">Digital Fluency Training</td>
                                    <td class="text-center small">7</td>
                                    <td class="text-center"><span class="badge bg-secondary small">Monthly</span></td>
                                    <td class="text-center small">81%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Insights -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card border shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-tasks text-secondary me-2"></i>
                        Key Action Areas
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-borderless table-sm">
                            <tbody>
                                <tr>
                                    <td class="text-muted small">Process Automation</td>
                                    <td class="text-end">
                                        <span class="badge bg-dark text-white small">High Priority</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">Team Collaboration Tools</td>
                                    <td class="text-end">
                                        <span class="badge bg-dark text-white small">High Priority</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">Data Analytics Training</td>
                                    <td class="text-end">
                                        <span class="badge bg-secondary small">Medium Priority</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">Digital Communication</td>
                                    <td class="text-end">
                                        <span class="badge bg-secondary small">Medium Priority</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">System Integration</td>
                                    <td class="text-end">
                                        <span class="badge bg-light text-dark border small">Low Priority</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card border shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-clock text-secondary me-2"></i>
                        Submission Metrics
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-borderless table-sm">
                            <tbody>
                                <tr>
                                    <td class="text-muted small">Average Completion Time</td>
                                    <td class="text-end"><span class="badge bg-dark text-white small">5 days</span></td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">Fastest Completion</td>
                                    <td class="text-end"><span class="badge bg-dark text-white small">1 day</span></td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">Latest Completion</td>
                                    <td class="text-end"><span class="badge bg-secondary small">14 days</span></td>
                                </tr>
                                <tr>
                                    <td class="text-muted small">This Week's Submissions</td>
                                    <td class="text-end"><span class="badge bg-dark text-white small">8</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Participants Tab -->
<div class="tab-pane fade" id="participants" role="tabpanel">
    <!-- Search and Filter Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-lg-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="participantSearch" placeholder="Search by name, email, or employee ID...">
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="completed">Survey Completed</option>
                                <option value="pending">Survey Pending</option>
                            </select>
                        </div>
                        <div class="col-lg-3">
                            <select class="form-select" id="practiceFilter">
                                <option value="">All Practices</option>
                                <option value="weekly">Weekly Practices</option>
                                <option value="monthly">Monthly Practices</option>
                                <option value="quarterly">Quarterly Practices</option>
                            </select>
                        </div>
                        <div class="col-lg-2">
                            <button class="btn btn-outline-primary w-100" onclick="resetFilters()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Participants Table -->
    <div class="card shadow">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="m-0 fw-bold text-primary">
                    <i class="fas fa-users me-2"></i>
                    Participants Management (<span id="participantCount">{{ total_pledges }}</span>)
                </h6>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="exportParticipants('csv')">
                        <i class="fas fa-file-csv me-1"></i>CSV
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="exportParticipants('excel')">
                        <i class="fas fa-file-excel me-1"></i>Excel
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="downloadComprehensivePPT()">
                        <i class="fas fa-file-powerpoint me-1"></i>PPT with Charts
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="generateBulkReports()">
                        <i class="fas fa-file-pdf me-1"></i>Bulk Reports
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="participantsTable">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0">
                                <input type="checkbox" id="selectAll" onchange="toggleAllParticipants()">
                            </th>
                            <th class="border-0">Name</th>
                            <th class="border-0">Email</th>
                            <th class="border-0">Employee ID</th>
                            <th class="border-0">Phone</th>
                            <th class="border-0">Survey Status</th>
                            <th class="border-0">Last Activity</th>
                            <th class="border-0">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for participant in participants %}
                        <tr class="participant-row" data-name="{{ participant.name|lower }}" data-email="{{ participant.email|lower }}" data-employee-id="{{ participant.employee_id|lower }}">
                            <td>
                                <input type="checkbox" class="participant-checkbox" value="{{ participant.user_id }}">
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar me-2">
                                        <div class="avatar-initial bg-primary text-white rounded-circle" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                            {{ participant.name[:2]|upper }}
                                        </div>
                                    </div>
                                    <div>
                                        <strong>{{ participant.name }}</strong>
                                        {% if participant.designation and participant.designation != 'N/A' %}
                                        <br><small class="text-muted">{{ participant.designation }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="text-break">{{ participant.email }}</span>
                            </td>
                            <td>
                                <span class="badge bg-light text-dark">{{ participant.employee_id or 'N/A' }}</span>
                            </td>
                            <td>
                                {% if participant.phone %}
                                    <span class="text-dark">{{ participant.phone }}</span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if participant.survey_responses|length > 0 %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Completed ({{ participant.survey_responses|length }})
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-clock me-1"></i>
                                        Pending
                                    </span>
                                {% endif %}
                                {% if participant.has_expert_comments and participant.survey_responses|length == 0 %}
                                    <br><small class="badge bg-info text-white mt-1">
                                        <i class="fas fa-comment me-1"></i>
                                        Has Comments
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                {% if participant.last_survey_date %}
                                    <small class="text-muted">{{ participant.last_survey_date }}</small>
                                {% else %}
                                    <small class="text-muted">Not started</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    {% if participant.survey_responses|length > 0 %}
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewParticipantDetails({{ participant.user_id }})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a class="btn btn-outline-success btn-sm" href="{{ url_for('admin_download_report', user_id=participant.user_id) }}" title="Download Report">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteParticipantSurvey({{ participant.user_id }})" title="Delete Survey Data">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="btn btn-outline-dark btn-sm" onclick="deleteParticipantComments({{ participant.user_id }})" title="Delete Expert Comments">
                                        <i class="fas fa-comment-slash"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-warning btn-sm" onclick="addComments({{ participant.user_id }})" title="Add Expert Comments">
                                        <i class="fas fa-comment"></i>
                                    </button>

                                    <button class="btn btn-outline-secondary btn-sm" onclick="editParticipant({{ participant.user_id }})" title="Edit Participant">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Panel -->
    <div class="card shadow-sm mt-4" id="bulkActionsPanel" style="display: none;">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong><span id="selectedCount">0</span> participants selected</strong>
                </div>
                <div class="btn-group">
                    <button class="btn btn-info" onclick="exportSelected()">
                        <i class="fas fa-download me-1"></i>Export Selected
                    </button>
                    <button class="btn btn-danger" onclick="generateBulkReports()">
                        <i class="fas fa-file-pdf me-1"></i>Generate Reports
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Corporate Analytics Tab -->
<div class="tab-pane fade" id="analytics" role="tabpanel">
    <!-- Corporate Analytics Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border shadow-sm">
                <div class="card-header bg-light border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-chart-line text-secondary me-2"></i>
                        Analytics Summary
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="text-center">
                                <h4 class="text-dark mb-1">{% if total_pledges > 0 %}{{ ((total_surveys / total_pledges) * 100)|round(1) }}%{% else %}0%{% endif %}</h4>
                                <p class="text-muted mb-0 small text-uppercase">Completion Rate</p>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="text-center">
                                <h4 class="text-dark mb-1">{{ practice_stats.HIGH|default(0) }}</h4>
                                <p class="text-muted mb-0 small text-uppercase">High Impact Practices</p>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="text-center">
                                <h4 class="text-dark mb-1">{{ total_surveys }}</h4>
                                <p class="text-muted mb-0 small text-uppercase">Total Assessments</p>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 mb-3">
                            <div class="text-center">
                                <h4 class="text-dark mb-1">{{ practice_stats.total_practices|default(0) }}</h4>
                                <p class="text-muted mb-0 small text-uppercase">Practice Entries</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Corporate Performance Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-chart-bar text-secondary me-2"></i>
                        Performance Overview
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-borderless">
                            <tbody>
                                <tr>
                                    <td class="text-muted">Total Enrolled Participants</td>
                                    <td class="text-end fw-semibold">{{ total_pledges }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Assessment Completions</td>
                                    <td class="text-end fw-semibold">{{ total_surveys }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Overall Completion Rate</td>
                                    <td class="text-end fw-semibold">{% if total_pledges > 0 %}{{ ((total_surveys / total_pledges) * 100)|round(1) }}%{% else %}0%{% endif %}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">High Impact Implementations</td>
                                    <td class="text-end fw-semibold">{{ practice_stats.HIGH|default(0) }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Medium Impact Implementations</td>
                                    <td class="text-end fw-semibold">{{ practice_stats.MEDIUM|default(0) }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Total Practice Implementations</td>
                                    <td class="text-end fw-semibold">{{ practice_stats.total_practices|default(0) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Survey Submission Analytics Charts -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card border shadow-sm">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h6 class="m-0 fw-semibold">
                        <i class="fas fa-chart-pie me-2"></i>
                        Survey Completion Status
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="position-relative" style="height: 300px;">
                        <canvas id="surveyCompletionChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between text-sm">
                            <span class="text-muted">
                                <i class="fas fa-circle text-success me-1"></i>
                                Completed: <strong>{{ total_surveys }}</strong>
                            </span>
                            <span class="text-muted">
                                <i class="fas fa-circle text-warning me-1"></i>
                                Pending: <strong>{{ total_pledges - total_surveys }}</strong>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Additional Analytics Charts -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card border shadow-sm">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h6 class="m-0 fw-semibold">
                        <i class="fas fa-chart-area me-2"></i>
                        Participant Engagement Overview
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="position-relative" style="height: 350px;">
                        <canvas id="engagementOverviewChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border shadow-sm">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%); color: #333 !important;">
                    <h6 class="m-0 fw-semibold text-dark">
                        <i class="fas fa-chart-line me-2"></i>
                        Completion Progress
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="position-relative" style="height: 350px;">
                        <canvas id="completionProgressChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Implementation Analysis -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card border shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-chart-pie text-secondary me-2"></i>
                        Impact Analysis
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-borderless table-sm">
                            <tbody>
                                <tr>
                                    <td class="text-muted">High Impact Practices</td>
                                    <td class="text-end">
                                        <span class="badge bg-dark text-white">{{ practice_stats.HIGH|default(0) }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Medium Impact Practices</td>
                                    <td class="text-end">
                                        <span class="badge bg-secondary">{{ practice_stats.MEDIUM|default(0) }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Low Impact Practices</td>
                                    <td class="text-end">
                                        <span class="badge bg-light text-dark border">{{ practice_stats.LOW|default(0) }}</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-list text-secondary me-2"></i>
                        Top Digital Practices
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="table-responsive">
                        <table class="table table-borderless table-sm">
                            <thead>
                                <tr class="border-bottom">
                                    <th class="text-muted small">Practice Area</th>
                                    <th class="text-muted small text-center">Count</th>
                                    <th class="text-muted small text-center">Impact</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="small">Dashboard Implementation</td>
                                    <td class="text-center small">15</td>
                                    <td class="text-center"><span class="badge bg-dark text-white small">HIGH</span></td>
                                </tr>
                                <tr>
                                    <td class="small">Digital Team Routines</td>
                                    <td class="text-center small">12</td>
                                    <td class="text-center"><span class="badge bg-dark text-white small">HIGH</span></td>
                                </tr>
                                <tr>
                                    <td class="small">Data-Driven Decisions</td>
                                    <td class="text-center small">8</td>
                                    <td class="text-center"><span class="badge bg-secondary small">MEDIUM</span></td>
                                </tr>
                                <tr>
                                    <td class="small">Digital Experiments</td>
                                    <td class="text-center small">6</td>
                                    <td class="text-center"><span class="badge bg-dark text-white small">HIGH</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="row">
        <div class="col-12">
            <div class="card border shadow-sm">
                <div class="card-header bg-light border-bottom py-3">
                    <h6 class="m-0 text-dark fw-semibold text-uppercase">
                        <i class="fas fa-file-text text-secondary me-2"></i>
                        Executive Summary
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-lg-8">
                            <h6 class="text-dark mb-3">Digital Transformation Progress</h6>
                            <div class="progress mb-3 bg-light" style="height: 6px;">
                                <div class="progress-bar bg-dark" role="progressbar" style="width: {% if total_pledges > 0 %}{{ ((total_surveys / total_pledges) * 100)|round(1) }}%{% else %}0%{% endif %}" aria-valuenow="{% if total_pledges > 0 %}{{ ((total_surveys / total_pledges) * 100)|round(1) }}{% else %}0{% endif %}" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <p class="text-muted mb-0 small">
                                <strong>{{ total_surveys }} of {{ total_pledges }}</strong> participants have completed their digital culture assessments, 
                                representing <strong>{% if total_pledges > 0 %}{{ ((total_surveys / total_pledges) * 100)|round(1) }}%{% else %}0%{% endif %}</strong> completion rate.
                                Implementation focus continues on high-impact digital practices across organizational units.
                            </p>
                        </div>
                        <div class="col-lg-4">
                            <h6 class="text-dark mb-3">Status Overview</h6>
                            <ul class="list-unstyled mb-0 small">
                                <li class="mb-2 text-muted"><i class="fas fa-circle text-secondary me-2" style="font-size: 8px;"></i>Dashboard implementation initiatives active</li>
                                <li class="mb-2 text-muted"><i class="fas fa-circle text-secondary me-2" style="font-size: 8px;"></i>Team digital routines established</li>
                                <li class="mb-2 text-muted"><i class="fas fa-circle text-secondary me-2" style="font-size: 8px;"></i>Data-driven decision processes ongoing</li>
                                <li class="mb-0 text-muted"><i class="fas fa-circle text-secondary me-2" style="font-size: 8px;"></i>Digital experimentation programs deployed</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Survey Builder Tab -->
<div class="tab-pane fade" id="survey-builder" role="tabpanel">
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-white">
                    <h6 class="m-0 fw-bold text-primary">
                        <i class="fas fa-edit me-2"></i>
                        Survey Questions Management
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Question List -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Survey Questions</h6>
                        <button class="btn btn-primary btn-sm" onclick="addNewQuestion()">
                            <i class="fas fa-plus me-1"></i>Add Question
                        </button>
                    </div>
                    
                    <div id="questionsList" class="list-group">
                        <!-- Weekly Practice Questions -->
                        <div class="list-group-item question-item" data-question-id="weekly_practice">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 text-success">Weekly Practice Implementation</h6>
                                    <p class="mb-1 text-muted">Rate the impact of your weekly digital practice implementation</p>
                                    <small class="text-muted">Type: Rating Scale (HIGH/MEDIUM/LOW)</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="editQuestion('weekly_practice')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="duplicateQuestion('weekly_practice')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteQuestion('weekly_practice')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monthly Practice Questions -->
                        <div class="list-group-item question-item" data-question-id="monthly_practice">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 text-warning">Monthly Practice Implementation</h6>
                                    <p class="mb-1 text-muted">Assess your monthly digital transformation initiatives</p>
                                    <small class="text-muted">Type: Rating Scale + Text Response</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="editQuestion('monthly_practice')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="duplicateQuestion('monthly_practice')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteQuestion('monthly_practice')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Behavior Change Questions -->
                        <div class="list-group-item question-item" data-question-id="behavior_change">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 text-info">Behavior Change Assessment</h6>
                                    <p class="mb-1 text-muted">START, REDUCE, STOP behavior tracking with action details</p>
                                    <small class="text-muted">Type: Multi-part Text Response</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="editQuestion('behavior_change')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="duplicateQuestion('behavior_change')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteQuestion('behavior_change')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logic Rules Section -->
                    <div class="mt-4">
                        <h6>Logic Rules & Conditional Visibility</h6>
                        <div class="card border-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Show Question</label>
                                        <select class="form-select form-select-sm">
                                            <option>Monthly Practice 2</option>
                                            <option>Quarterly Practice 3</option>
                                            <option>Behavior Change Follow-up</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">When Previous Answer Is</label>
                                        <select class="form-select form-select-sm">
                                            <option>HIGH Impact</option>
                                            <option>MEDIUM Impact</option>
                                            <option>Any Response</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-plus me-1"></i>Add Rule
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Preview Mode -->
            <div class="card shadow mb-4">
                <div class="card-header bg-white">
                    <h6 class="m-0 fw-bold text-primary">
                        <i class="fas fa-eye me-2"></i>
                        Survey Preview
                    </h6>
                </div>
                <div class="card-body">
                    <div class="btn-group w-100 mb-3">
                        <button class="btn btn-outline-primary active" onclick="switchPreview('desktop')">
                            <i class="fas fa-desktop me-1"></i>Desktop
                        </button>
                        <button class="btn btn-outline-primary" onclick="switchPreview('mobile')">
                            <i class="fas fa-mobile-alt me-1"></i>Mobile
                        </button>
                    </div>
                    
                    <div id="surveyPreview" class="border rounded p-3" style="background: #f8f9fa; min-height: 300px;">
                        <div class="preview-content">
                            <h6 class="text-primary">Digital Culture Survey Preview</h6>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Weekly Practice Implementation</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="weekly_impact" disabled>
                                    <label class="form-check-label">HIGH Impact</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="weekly_impact" disabled>
                                    <label class="form-check-label">MEDIUM Impact</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="weekly_impact" disabled>
                                    <label class="form-check-label">LOW Impact</label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Action Taken</label>
                                <textarea class="form-control form-control-sm" rows="2" disabled placeholder="Describe what you implemented..."></textarea>
                            </div>
                            
                            <div class="text-center">
                                <button class="btn btn-primary btn-sm" disabled>Submit Survey</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Question Properties -->
            <div class="card shadow">
                <div class="card-header bg-white">
                    <h6 class="m-0 fw-bold text-primary">
                        <i class="fas fa-cogs me-2"></i>
                        Question Properties
                    </h6>
                </div>
                <div class="card-body">
                    <form id="questionPropertiesForm">
                        <div class="mb-3">
                            <label class="form-label">Question Type</label>
                            <select class="form-select form-select-sm">
                                <option>Rating Scale</option>
                                <option>Text Response</option>
                                <option>Multiple Choice</option>
                                <option>Checkbox</option>
                                <option>Date/Time</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requiredField">
                                <label class="form-check-label" for="requiredField">
                                    Required Field
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="conditionalVisibility">
                                <label class="form-check-label" for="conditionalVisibility">
                                    Conditional Visibility
                                </label>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary btn-sm w-100">
                            Update Question
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Impact Analysis Tab -->
<div class="tab-pane fade" id="impact-analysis" role="tabpanel">
    <div class="container-fluid">
        <!-- Impact Analysis Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body text-white py-4">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="fw-bold mb-2">
                                    <i class="fas fa-chart-bar me-3" style="color: #ffd700;"></i>
                                    Impact Analysis Dashboard
                                </h4>
                                <p class="mb-3 text-white-50">Comprehensive analysis of user impact levels across weekly, monthly, and quarterly practices with survey responses</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-light btn-sm fw-semibold" onclick="downloadImpactCharts()" title="Download Chart Images">
                                        <i class="fas fa-download me-2"></i>Download Charts
                                    </button>
                                    <button class="btn btn-warning btn-sm fw-semibold" onclick="refreshImpactData()" title="Refresh Data">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Impact Summary Cards -->
        <div class="row mb-4">
            <div class="col-lg-4 mb-3">
                <div class="card border-0 shadow h-100" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="card-body text-white text-center py-4">
                        <i class="fas fa-trophy fa-3x mb-3" style="color: #ffd700;"></i>
                        <h3 class="fw-bold" id="highImpactCount">
                            {{ impact_analysis.high_impact.weekly|length + impact_analysis.high_impact.monthly|length + impact_analysis.high_impact.quarterly|length }}
                        </h3>
                        <p class="mb-0 fw-semibold">HIGH IMPACT RESPONSES</p>
                        <small class="text-white-75">Exceptional performance</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-3">
                <div class="card border-0 shadow h-100" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);">
                    <div class="card-body text-white text-center py-4">
                        <i class="fas fa-star fa-3x mb-3" style="color: #fff;"></i>
                        <h3 class="fw-bold" id="mediumImpactCount">
                            {{ impact_analysis.medium_impact.weekly|length + impact_analysis.medium_impact.monthly|length + impact_analysis.medium_impact.quarterly|length }}
                        </h3>
                        <p class="mb-0 fw-semibold">MEDIUM IMPACT RESPONSES</p>
                        <small class="text-white-75">Steady progress</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-3">
                <div class="card border-0 shadow h-100" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    <div class="card-body text-white text-center py-4">
                        <i class="fas fa-chart-line fa-3x mb-3" style="color: #fff;"></i>
                        <h3 class="fw-bold" id="lowImpactCount">
                            {{ impact_analysis.low_impact.weekly|length + impact_analysis.low_impact.monthly|length + impact_analysis.low_impact.quarterly|length }}
                        </h3>
                        <p class="mb-0 fw-semibold">LOW IMPACT RESPONSES</p>
                        <small class="text-white-75">Needs improvement</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactive Charts Section -->
        <div class="row mb-4">
            <!-- Impact Distribution by Practice Type Chart -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 fw-bold text-primary">
                            <i class="fas fa-chart-column me-2"></i>
                            Impact Distribution by Practice Type
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="impactDistributionChart" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- High Impact Users by Practice Type Chart -->
            <div class="col-lg-6 mb-4">
                <div class="card border-0 shadow">
                    <div class="card-header bg-white py-3">
                        <h6 class="m-0 fw-bold text-success">
                            <i class="fas fa-trophy me-2"></i>
                            High Impact Users by Practice Type
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="highImpactChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>



        <!-- Weekly Practices Selection Analysis -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;">
                        <h6 class="m-0 fw-bold">
                            <i class="fas fa-chart-bar me-2"></i>
                            Weekly Practices Selection Analysis
                        </h6>
                        <button class="btn btn-sm btn-outline-light" onclick="downloadWeeklyChart()">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <h6 class="text-muted mb-3">Weekly Practices Selection Frequency</h6>
                                <div style="width: 600px; height: 150px; max-width: 600px; max-height: 150px;">
                                    <canvas id="weeklyPracticesChart" width="600" height="150"></canvas>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card bg-light border-0 h-100">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="m-0 fw-bold">
                                            <i class="fas fa-trophy me-2"></i>
                                            Weekly Practices Ranking
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="weeklyRankingList" class="ranking-list">
                                            <!-- Dynamic content loaded via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Practices Selection Analysis -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%); color: white;">
                        <h6 class="m-0 fw-bold">
                            <i class="fas fa-chart-bar me-2"></i>
                            Monthly Practices Selection Analysis
                        </h6>
                        <button class="btn btn-sm btn-outline-light" onclick="downloadMonthlyChart()">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <h6 class="text-muted mb-3">Monthly Practices Selection Frequency</h6>
                                <div style="width: 600px; height: 150px; max-width: 600px; max-height: 150px;">
                                    <canvas id="monthlyPracticesChart" width="600" height="150"></canvas>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card bg-light border-0 h-100">
                                    <div class="card-header bg-warning text-white">
                                        <h6 class="m-0 fw-bold">
                                            <i class="fas fa-trophy me-2"></i>
                                            Monthly Practices Ranking
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="monthlyRankingList" class="ranking-list">
                                            <!-- Dynamic content loaded via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quarterly Practices Selection Analysis -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%); color: white;">
                        <h6 class="m-0 fw-bold">
                            <i class="fas fa-chart-bar me-2"></i>
                            Quarterly Practices Selection Analysis
                        </h6>
                        <button class="btn btn-sm btn-outline-light" onclick="downloadQuarterlyChart()">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <h6 class="text-muted mb-3">Quarterly Practices Selection Frequency</h6>
                                <div style="width: 600px; height: 150px; max-width: 600px; max-height: 150px;">
                                    <canvas id="quarterlyPracticesChart" width="600" height="150"></canvas>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="card bg-light border-0 h-100">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="m-0 fw-bold">
                                            <i class="fas fa-trophy me-2"></i>
                                            Quarterly Practices Ranking
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="quarterlyRankingList" class="ranking-list">
                                            <!-- Dynamic content loaded via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Practice Impact Analysis Tables -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info border-0 shadow-sm">
                    <h5 class="alert-heading mb-3">
                        <i class="fas fa-analytics me-2"></i>Practice Impact Analysis Summary
                    </h5>
                    <p class="mb-0">The following tables show detailed impact analysis for all practices across different frequencies.</p>
                </div>
            </div>
        </div>

        <!-- Weekly Practices Section Header -->
        <div class="row mb-3">
            <div class="col-12">
                <h4 class="text-danger fw-bold border-bottom border-danger pb-2">
                    <i class="fas fa-calendar-week me-2"></i>Weekly Practices
                </h4>
            </div>
        </div>

        <!-- Weekly Practices Impact Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-week me-2"></i>Weekly Practices - Impact Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="weeklyPracticeTable">
                                <thead class="table-danger">
                                    <tr>
                                        <th>Practice Name</th>
                                        <th class="text-center">
                                            <div class="fw-bold">High Impact</div>
                                            <small class="text-muted">Users with High Impact</small>
                                        </th>
                                        <th class="text-center">
                                            <div class="fw-bold">Medium Impact</div>
                                            <small class="text-muted">Users with Medium Impact</small>
                                        </th>
                                        <th class="text-center">
                                            <div class="fw-bold">Low Impact</div>
                                            <small class="text-muted">Users with Low Impact</small>
                                        </th>
                                        <th class="text-center">Total Users</th>
                                    </tr>
                                </thead>
                                <tbody id="weeklyPracticeTableBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Practices Section Header -->
        <div class="row mb-3">
            <div class="col-12">
                <h4 class="text-warning fw-bold border-bottom border-warning pb-2">
                    <i class="fas fa-calendar-alt me-2"></i>Monthly Practices
                </h4>
            </div>
        </div>

        <!-- Monthly Practices Impact Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>Monthly Practices - Impact Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="monthlyPracticeTable">
                                <thead class="table-warning">
                                    <tr>
                                        <th>Practice Name</th>
                                        <th class="text-center">
                                            <div class="fw-bold">High Impact</div>
                                            <small class="text-muted">Users with High Impact</small>
                                        </th>
                                        <th class="text-center">
                                            <div class="fw-bold">Medium Impact</div>
                                            <small class="text-muted">Users with Medium Impact</small>
                                        </th>
                                        <th class="text-center">
                                            <div class="fw-bold">Low Impact</div>
                                            <small class="text-muted">Users with Low Impact</small>
                                        </th>
                                        <th class="text-center">Total Users</th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyPracticeTableBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quarterly Practices Section Header -->
        <div class="row mb-3">
            <div class="col-12">
                <h4 class="text-primary fw-bold border-bottom border-primary pb-2">
                    <i class="fas fa-calendar me-2"></i>Quarterly Practices
                </h4>
            </div>
        </div>

        <!-- Quarterly Practices Impact Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header text-white" style="background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar me-2"></i>Quarterly Practices - Impact Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="quarterlyPracticeTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Practice Name</th>
                                        <th class="text-center">
                                            <div class="fw-bold">High Impact</div>
                                            <small class="text-muted">Users with High Impact</small>
                                        </th>
                                        <th class="text-center">
                                            <div class="fw-bold">Medium Impact</div>
                                            <small class="text-muted">Users with Medium Impact</small>
                                        </th>
                                        <th class="text-center">
                                            <div class="fw-bold">Low Impact</div>
                                            <small class="text-muted">Users with Low Impact</small>
                                        </th>
                                        <th class="text-center">Total Users</th>
                                    </tr>
                                </thead>
                                <tbody id="quarterlyPracticeTableBody">
                                    <!-- Dynamic content will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- User Impact Details Tables -->
        <div class="row">
            <!-- High Impact Users Table -->
            <div class="col-12 mb-4">
                <div class="card border-0 shadow">
                    <div class="card-header py-3" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                        <h6 class="m-0 fw-bold">
                            <i class="fas fa-trophy me-2"></i>
                            High Impact Users - Detailed Analysis
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-success">
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Practice Type</th>
                                        <th>Pledge</th>
                                        <th>Survey Response</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="highImpactUsersTable">
                                    {% for practice_type in ['weekly', 'monthly', 'quarterly'] %}
                                        {% for user in impact_analysis.high_impact[practice_type] %}
                                        <tr>
                                            <td class="fw-bold">{{ user.name }}</td>
                                            <td>{{ user.email }}</td>
                                            <td>
                                                <span class="badge bg-success rounded-pill">{{ practice_type.upper() }}</span>
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ user.pledge_data.problem_statement[:50] }}...</small>
                                            </td>
                                            <td>
                                                {% for response_key, response_data in user.survey_responses.items() %}
                                                <small class="text-success fw-bold">{{ response_data.impact }}</small><br>
                                                <small>{{ response_data.response.action_taken[:30] }}...</small>
                                                {% endfor %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewUserImpactDetails({{ user.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Behavior Analysis Charts -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-warning border-0 shadow-sm">
                    <h5 class="alert-heading mb-3">
                        <i class="fas fa-chart-bar me-2"></i>Behavior Analysis Charts
                    </h5>
                    <p class="mb-0">Visual analysis of participant behavior commitments across START, REDUCE, and STOP categories.</p>
                </div>
            </div>
        </div>

        <!-- START Behaviors Chart -->
        <div class="row mb-3">
            <div class="col-12">
                <h4 class="text-success fw-bold border-bottom border-success pb-2">
                    <i class="fas fa-play me-2"></i>Behaviors to START
                </h4>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <canvas id="startBehaviorsChart" width="600" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- REDUCE Behaviors Chart -->
        <div class="row mb-3">
            <div class="col-12">
                <h4 class="text-warning fw-bold border-bottom border-warning pb-2">
                    <i class="fas fa-minus-circle me-2"></i>Behaviors to REDUCE
                </h4>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <canvas id="reduceBehaviorsChart" width="600" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- STOP Behaviors Chart -->
        <div class="row mb-3">
            <div class="col-12">
                <h4 class="text-danger fw-bold border-bottom border-danger pb-2">
                    <i class="fas fa-stop me-2"></i>Behaviors to STOP
                </h4>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <canvas id="stopBehaviorsChart" width="600" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings & Access Control Tab -->
<div class="tab-pane fade" id="settings" role="tabpanel">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- User Roles & Permissions -->
            <div class="card shadow">
                <div class="card-header bg-white">
                    <h6 class="m-0 fw-bold text-primary">
                        <i class="fas fa-users-cog me-2"></i>
                        User Roles & Permissions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white;">ROLE</th>
                                    <th style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white;">USERS</th>
                                    <th style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white;">PERMISSIONS</th>
                                    <th style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white;">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <span class="badge bg-danger rounded-pill px-3 py-2">ADMIN</span>
                                    </td>
                                    <td class="fw-bold">2</td>
                                    <td>Full Access</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="updateUserRole('admin')">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="badge bg-warning rounded-pill px-3 py-2">MENTOR</span>
                                    </td>
                                    <td class="fw-bold">5</td>
                                    <td>Group Management</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="updateUserRole('mentor')">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <span class="badge bg-info rounded-pill px-3 py-2">CLIENT</span>
                                    </td>
                                    <td class="fw-bold">12</td>
                                    <td>View Reports Only</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="updateUserRole('client')">
                                            <i class="fas fa-edit me-1"></i>Edit
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary rounded-pill px-4" onclick="addNewRole()">
                            <i class="fas fa-plus me-2"></i>Add New Role
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals and Enhanced JavaScript -->

<!-- Participant Details Modal -->
<div class="modal fade" id="participantModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="participantModalTitle">Participant Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="participantModalBody">
                <!-- Dynamic content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editParticipantFromModal()">Edit Participant</button>
            </div>
        </div>
    </div>
</div>

<!-- Comments Modal -->
<div class="modal fade" id="commentsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Expert Comments</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="commentsForm">
                    <input type="hidden" id="commentUserId">
                    <div class="mb-3">
                        <label for="expertComments" class="form-label">Add Expert Comments</label>
                        <textarea class="form-control" id="expertComments" rows="4" placeholder="Enter your feedback for this participant..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveComments()">Save Comments</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Enhanced Admin Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    initializeParticipantFiltering();
    initializeReportGeneration();
});

// Chart Initialization
function initializeCharts() {
    // Practice Impact Chart (if data available)
    if (document.getElementById('practiceImpactChart')) {
        const ctx = document.getElementById('practiceImpactChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Weekly Practices', 'Monthly Practices', 'Quarterly Practices'],
                datasets: [{
                    label: 'High Impact',
                    data: [{{ practice_stats.HIGH|default(0) }}, {{ practice_stats.HIGH|default(0) }}, {{ practice_stats.HIGH|default(0) }}],
                    backgroundColor: '#28a745',
                    borderColor: '#1e7e34',
                    borderWidth: 1
                }, {
                    label: 'Medium Impact',
                    data: [{{ practice_stats.MEDIUM|default(0) }}, {{ practice_stats.MEDIUM|default(0) }}, {{ practice_stats.MEDIUM|default(0) }}],
                    backgroundColor: '#ffc107',
                    borderColor: '#e0a800',
                    borderWidth: 1
                }, {
                    label: 'Low Impact',
                    data: [{{ practice_stats.LOW|default(0) }}, {{ practice_stats.LOW|default(0) }}, {{ practice_stats.LOW|default(0) }}],
                    backgroundColor: '#dc3545',
                    borderColor: '#c82333',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Behavior Distribution Chart
    if (document.getElementById('behaviorDistributionChart')) {
        const ctx2 = document.getElementById('behaviorDistributionChart').getContext('2d');
        new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: ['START Behaviors', 'REDUCE Behaviors', 'STOP Behaviors'],
                datasets: [{
                    data: [30, 25, 20], // These would be dynamic
                    backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                    borderColor: ['#1e7e34', '#e0a800', '#c82333'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Timeline Chart
    if (document.getElementById('submissionTimelineChart')) {
        const ctx3 = document.getElementById('submissionTimelineChart').getContext('2d');
        new Chart(ctx3, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Survey Submissions',
                    data: [5, 8, 12, 15],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Initialize behavior charts
    initializeBehaviorCharts();
}

// Behavior Charts Initialization
function initializeBehaviorCharts() {
    // Fetch behavior analysis data
    fetch('/admin/api/impact-analysis')
        .then(response => response.json())
        .then(data => {
            console.log('Behavior analysis data:', data);
            if (data.behavior_analysis) {
                createBehaviorChart('startBehaviorsChart', data.behavior_analysis.start_behaviors, 'START Behaviors', '#28a745');
                createBehaviorChart('reduceBehaviorsChart', data.behavior_analysis.reduce_behaviors, 'REDUCE Behaviors', '#ffc107');
                createBehaviorChart('stopBehaviorsChart', data.behavior_analysis.stop_behaviors, 'STOP Behaviors', '#dc3545');
            } else {
                console.log('No behavior analysis data found');
            }
        })
        .catch(error => {
            console.error('Error loading behavior analysis:', error);
        });
}

function createBehaviorChart(canvasId, behaviorData, title, color) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Sort behaviors by count and get top 10
    const sortedBehaviors = Object.entries(behaviorData)
        .filter(([behavior, count]) => behavior !== 'Not specified' && behavior.trim() !== '')
        .sort(([, a], [, b]) => b - a)
        .slice(0, 10);
    
    const labels = sortedBehaviors.map(([behavior, count]) => {
        // Truncate long behavior names for better display
        return behavior.length > 30 ? behavior.substring(0, 30) + '...' : behavior;
    });
    const counts = sortedBehaviors.map(([, count]) => count);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'No of Participants',
                data: counts,
                backgroundColor: color,
                borderColor: color,
                borderWidth: 1
            }]
        },
        options: {
            responsive: false,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: title,
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                }
            }
        }
    });
}

// Participant Filtering
function initializeParticipantFiltering() {
    const searchInput = document.getElementById('participantSearch');
    const statusFilter = document.getElementById('statusFilter');
    const practiceFilter = document.getElementById('practiceFilter');

    if (searchInput) {
        searchInput.addEventListener('input', filterParticipants);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterParticipants);
    }
    if (practiceFilter) {
        practiceFilter.addEventListener('change', filterParticipants);
    }
}

function filterParticipants() {
    const searchTerm = document.getElementById('participantSearch')?.value.toLowerCase() || '';
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const practiceFilter = document.getElementById('practiceFilter')?.value || '';
    
    const rows = document.querySelectorAll('.participant-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.dataset.name || '';
        const email = row.dataset.email || '';
        const employeeId = row.dataset.employeeId || '';
        const statusBadge = row.querySelector('.badge');
        const status = statusBadge ? statusBadge.textContent.toLowerCase() : '';
        
        let showRow = true;
        
        // Text search
        if (searchTerm && !name.includes(searchTerm) && !email.includes(searchTerm) && !employeeId.includes(searchTerm)) {
            showRow = false;
        }
        
        // Status filter
        if (statusFilter) {
            if (statusFilter === 'completed' && !status.includes('completed')) {
                showRow = false;
            } else if (statusFilter === 'pending' && !status.includes('pending')) {
                showRow = false;
            }
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    // Update participant count
    const countElement = document.getElementById('participantCount');
    if (countElement) {
        countElement.textContent = visibleCount;
    }
}

function resetFilters() {
    document.getElementById('participantSearch').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('practiceFilter').value = '';
    filterParticipants();
}

// Participant Management Functions
function viewParticipantDetails(userId) {
    fetch(`/admin/participant/${userId}/full-details`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('participantModalTitle').textContent = 'Participant Details';
            document.getElementById('participantModalBody').innerHTML = data.html;
            new bootstrap.Modal(document.getElementById('participantModal')).show();
        })
        .catch(error => {
            console.error('Error loading participant details:', error);
            showNotification('Error loading participant details', 'error');
        });
}

function editParticipant(userId) {
    // Redirect to participant edit page or open edit modal
    window.location.href = `/admin/participant/${userId}/edit`;
}



function downloadParticipantReport(userId) {
    window.location.href = `/admin/participant/${userId}/report`;
}

// Bulk Operations
function toggleAllParticipants() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.participant-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBulkActionsPanel();
}

function updateBulkActionsPanel() {
    const selectedCheckboxes = document.querySelectorAll('.participant-checkbox:checked');
    const count = selectedCheckboxes.length;
    
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('bulkActionsPanel').style.display = count > 0 ? 'block' : 'none';
}

// Add event listeners for participant checkboxes
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('participant-checkbox')) {
        updateBulkActionsPanel();
    }
});



function generateBulkReports() {
    const selectedIds = Array.from(document.querySelectorAll('.participant-checkbox:checked'))
        .map(cb => cb.value);
    
    showNotification('Generating bulk reports (Excel + Visual)...', 'info');
    
    // First download the Excel file
    if (selectedIds.length === 0) {
        // Download Excel for all participants
        window.location.href = '/export-data';
    } else {
        // Download Excel for selected participants
        window.location.href = '/export-data?ids=' + selectedIds.join(',');
    }
    
    // Then generate and open visual report after a short delay
    setTimeout(() => {
        generateVisualAnalyticsReport();
        showNotification('Bulk reports generated: Excel file downloaded + Visual report opened', 'success');
    }, 1000);
}

// Report Generation
function initializeReportGeneration() {
    const reportScope = document.getElementById('reportScope');
    if (reportScope) {
        reportScope.addEventListener('change', function() {
            const individualDiv = document.getElementById('individualParticipantDiv');
            if (individualDiv) {
                individualDiv.style.display = this.value === 'individual' ? 'block' : 'none';
            }
        });
    }
}

function generateCustomReport() {
    const scope = document.getElementById('reportScope').value;
    const format = document.getElementById('reportFormat').value;
    const individual = document.getElementById('individualParticipant')?.value;
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    
    const params = new URLSearchParams({
        scope: scope,
        format: format,
        from_date: fromDate,
        to_date: toDate
    });
    
    if (individual) {
        params.append('participant_id', individual);
    }
    
    window.location.href = `/admin/reports/custom?${params.toString()}`;
}

// Quick Action Functions
function generateAllParticipantReports() {
    window.location.href = '/admin/reports/bulk';
}

function downloadAnalyticsSummary() {
    window.location.href = '/admin/reports/analytics';
}

function exportMasterData() {
    window.location.href = '/export-data';
}

function generateCertificates() {
    showNotification('Certificate generation feature coming soon!', 'info');
}

// Export Functions
function exportParticipants(format) {
    if (format === 'csv') {
        window.location.href = '/admin/export/participants.csv';
    } else if (format === 'excel') {
        window.location.href = '/export-data';
    }
}

function exportSelected() {
    const selectedIds = Array.from(document.querySelectorAll('.participant-checkbox:checked'))
        .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
        showNotification('Please select participants first', 'warning');
        return;
    }
    
    window.location.href = '/export-data?ids=' + selectedIds.join(',');
}

// Utility Functions
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Comments functionality
function addComments(userId) {
    document.getElementById('commentUserId').value = userId;
    document.getElementById('expertComments').value = '';
    
    // Load existing comments if any
    fetch(`/admin/participant/${userId}/comments`)
        .then(response => response.json())
        .then(data => {
            if (data.comments) {
                document.getElementById('expertComments').value = data.comments;
            }
        })
        .catch(error => console.error('Error loading comments:', error));
    
    new bootstrap.Modal(document.getElementById('commentsModal')).show();
}

function saveComments() {
    const userId = document.getElementById('commentUserId').value;
    const comments = document.getElementById('expertComments').value;
    
    const formData = new FormData();
    formData.append('expert_comments', comments);
    
    fetch(`/admin/expert-comments/${userId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showNotification('Comments saved successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('commentsModal')).hide();
            location.reload(); // Refresh to show updated data
        } else {
            showNotification('Error saving comments', 'error');
        }
    })
    .catch(error => {
        console.error('Error saving comments:', error);
        showNotification('Error saving comments', 'error');
    });
}

// Delete Survey Data
function deleteParticipantSurvey(userId) {
    if (confirm('Are you sure you want to delete all survey data for this participant? This action cannot be undone.')) {
        fetch(`/admin/participant/${userId}/delete-survey`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Survey data deleted successfully', 'success');
                location.reload(); // Refresh to show updated data
            } else {
                showNotification(data.error || 'Error deleting survey data', 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting survey:', error);
            showNotification('Error deleting survey data', 'error');
        });
    }
}

// Delete Expert Comments
function deleteParticipantComments(userId) {
    if (confirm('Are you sure you want to delete all expert comments for this participant? This action cannot be undone.')) {
        fetch(`/admin/participant/${userId}/delete-comments`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Expert comments deleted successfully', 'success');
                location.reload(); // Refresh to show updated data
            } else {
                showNotification(data.error || 'Error deleting comments', 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting comments:', error);
            showNotification('Error deleting comments', 'error');
        });
    }
}

// Survey viewing functionality
function viewSurvey(userId) {
    fetch(`/admin/participant/${userId}/survey`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('participantModalTitle').textContent = 'Survey Response';
            document.getElementById('participantModalBody').innerHTML = data.html;
            new bootstrap.Modal(document.getElementById('participantModal')).show();
        })
        .catch(error => {
            console.error('Error loading survey:', error);
            showNotification('Error loading survey', 'error');
        });
}

// Survey Builder Functions - Enhanced with Real Functionality
function addNewQuestion() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Question</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newQuestionForm">
                        <div class="mb-3">
                            <label class="form-label">Question Title</label>
                            <input type="text" class="form-control" id="questionTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Question Description</label>
                            <textarea class="form-control" id="questionDescription" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Question Type</label>
                            <select class="form-select" id="questionType">
                                <option value="rating">Rating Scale (HIGH/MEDIUM/LOW)</option>
                                <option value="text">Text Response</option>
                                <option value="multiple_choice">Multiple Choice</option>
                                <option value="checkbox">Checkbox</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="questionCategory">
                                <option value="weekly">Weekly Practice</option>
                                <option value="monthly">Monthly Practice</option>
                                <option value="quarterly">Quarterly Practice</option>
                                <option value="behavior">Behavior Change</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isRequired">
                            <label class="form-check-label" for="isRequired">Required Question</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewQuestion()">Add Question</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    new bootstrap.Modal(modal).show();
}

function saveNewQuestion() {
    const title = document.getElementById('questionTitle').value;
    const description = document.getElementById('questionDescription').value;
    const type = document.getElementById('questionType').value;
    const category = document.getElementById('questionCategory').value;
    const required = document.getElementById('isRequired').checked;
    
    if (!title.trim()) {
        showNotification('Please enter a question title', 'error');
        return;
    }
    
    // Create new question element
    const questionsList = document.getElementById('questionsList');
    const newQuestion = document.createElement('div');
    newQuestion.className = 'list-group-item question-item';
    newQuestion.setAttribute('data-question-id', `custom_${Date.now()}`);
    
    const categoryColors = {
        weekly: 'text-success',
        monthly: 'text-warning', 
        quarterly: 'text-info',
        behavior: 'text-primary'
    };
    
    newQuestion.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
                <h6 class="mb-1 ${categoryColors[category]}">${title}</h6>
                <p class="mb-1 text-muted">${description}</p>
                <small class="text-muted">Type: ${type.replace('_', ' ').toUpperCase()}${required ? ' (Required)' : ''}</small>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="editQuestion('${newQuestion.dataset.questionId}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-primary" onclick="duplicateQuestion('${newQuestion.dataset.questionId}')">
                    <i class="fas fa-copy"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteQuestion('${newQuestion.dataset.questionId}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    questionsList.appendChild(newQuestion);
    
    // Close modal and show success
    const modalElement = document.querySelector('.modal.show');
    bootstrap.Modal.getInstance(modalElement).hide();
    showNotification('New question added successfully', 'success');
    
    // Update preview
    updateSurveyPreview();
}

function editQuestion(questionId) {
    const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
    if (!questionElement) {
        showNotification('Question not found', 'error');
        return;
    }
    
    const title = questionElement.querySelector('h6').textContent;
    const description = questionElement.querySelector('p').textContent;
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Question</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editQuestionForm">
                        <div class="mb-3">
                            <label class="form-label">Question Title</label>
                            <input type="text" class="form-control" id="editQuestionTitle" value="${title}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Question Description</label>
                            <textarea class="form-control" id="editQuestionDescription" rows="2">${description}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Question Status</label>
                            <select class="form-select" id="questionStatus">
                                <option value="active">Active</option>
                                <option value="draft">Draft</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedQuestion('${questionId}')">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    new bootstrap.Modal(modal).show();
}

function saveEditedQuestion(questionId) {
    const newTitle = document.getElementById('editQuestionTitle').value;
    const newDescription = document.getElementById('editQuestionDescription').value;
    const status = document.getElementById('questionStatus').value;
    
    const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
    if (questionElement) {
        questionElement.querySelector('h6').textContent = newTitle;
        questionElement.querySelector('p').textContent = newDescription;
        
        // Add status indicator
        if (status !== 'active') {
            questionElement.classList.add('opacity-50');
            questionElement.querySelector('small').textContent += ` (${status.toUpperCase()})`;
        }
    }
    
    const modalElement = document.querySelector('.modal.show');
    bootstrap.Modal.getInstance(modalElement).hide();
    showNotification('Question updated successfully', 'success');
    updateSurveyPreview();
}

function duplicateQuestion(questionId) {
    const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
    if (!questionElement) {
        showNotification('Question not found', 'error');
        return;
    }
    
    const clonedQuestion = questionElement.cloneNode(true);
    const newId = `duplicate_${Date.now()}`;
    clonedQuestion.setAttribute('data-question-id', newId);
    
    // Update the title to indicate it's a copy
    const title = clonedQuestion.querySelector('h6');
    title.textContent = title.textContent + ' (Copy)';
    
    // Update button onclick handlers
    const buttons = clonedQuestion.querySelectorAll('button[onclick]');
    buttons.forEach(button => {
        const onclick = button.getAttribute('onclick');
        button.setAttribute('onclick', onclick.replace(questionId, newId));
    });
    
    questionElement.parentNode.insertBefore(clonedQuestion, questionElement.nextSibling);
    showNotification('Question duplicated successfully', 'success');
    updateSurveyPreview();
}

function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
        const questionElement = document.querySelector(`[data-question-id="${questionId}"]`);
        if (questionElement) {
            questionElement.remove();
            showNotification('Question deleted successfully', 'success');
            updateSurveyPreview();
        } else {
            showNotification('Question not found', 'error');
        }
    }
}

function switchPreview(mode) {
    // Remove active class from all buttons
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    const preview = document.getElementById('surveyPreview');
    const previewContent = preview.querySelector('.preview-content');
    
    if (mode === 'mobile') {
        preview.style.maxWidth = '320px';
        preview.style.margin = '0 auto';
        previewContent.style.fontSize = '0.875rem';
        previewContent.style.padding = '0.5rem';
    } else {
        preview.style.maxWidth = '100%';
        preview.style.margin = '0';
        previewContent.style.fontSize = '1rem';
        previewContent.style.padding = '1rem';
    }
    
    showNotification(`Preview switched to ${mode} view`, 'info');
}

function updateSurveyPreview() {
    const questions = document.querySelectorAll('.question-item');
    const preview = document.getElementById('surveyPreview');
    
    let previewHTML = '<div class="preview-content"><h6 class="text-primary mb-3">Digital Culture Survey Preview</h6>';
    
    questions.forEach((question, index) => {
        const title = question.querySelector('h6').textContent;
        const type = question.querySelector('small').textContent;
        
        previewHTML += `
            <div class="mb-3">
                <label class="form-label fw-bold">${index + 1}. ${title}</label>
        `;
        
        if (type.includes('RATING')) {
            previewHTML += `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="q${index}" disabled>
                    <label class="form-check-label">HIGH Impact</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="q${index}" disabled>
                    <label class="form-check-label">MEDIUM Impact</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="q${index}" disabled>
                    <label class="form-check-label">LOW Impact</label>
                </div>
            `;
        } else if (type.includes('TEXT')) {
            previewHTML += `
                <textarea class="form-control form-control-sm" rows="2" disabled placeholder="Enter your response..."></textarea>
            `;
        } else if (type.includes('MULTIPLE')) {
            previewHTML += `
                <select class="form-select form-select-sm" disabled>
                    <option>Select an option...</option>
                    <option>Option 1</option>
                    <option>Option 2</option>
                </select>
            `;
        }
        
        previewHTML += '</div>';
    });
    
    previewHTML += `
        <div class="text-center mt-4">
            <button class="btn btn-primary btn-sm" disabled>Submit Survey</button>
        </div>
        </div>
    `;
    
    preview.innerHTML = previewHTML;
}

// Enhanced Reports Functions
function exportData(format) {
    if (format === 'excel') {
        window.location.href = '/export-data';
    } else if (format === 'csv') {
        window.location.href = '/export-data?format=csv';
    }
    showNotification(`Exporting data in ${format.toUpperCase()} format`, 'info');
}

function generateReports() {
    showNotification('Generating ZIP file with all participant reports...', 'info');
    window.location.href = '/admin/bulk-reports';
}

// Enhanced Reports with Client-Ready Features
function generateClientReport(type) {
    const params = new URLSearchParams();
    
    switch(type) {
        case 'individual':
            params.append('type', 'individual');
            params.append('format', 'pdf');
            break;
        case 'group':
            params.append('type', 'group');
            params.append('format', 'ppt');
            break;
        case 'summary':
            params.append('type', 'summary');
            params.append('format', 'pdf');
            break;
    }
    
    // Add filters
    const bu = document.getElementById('buFilter')?.value;
    const plant = document.getElementById('plantFilter')?.value;
    const dateFrom = document.getElementById('dateFromFilter')?.value;
    const dateTo = document.getElementById('dateToFilter')?.value;
    
    if (bu) params.append('bu', bu);
    if (plant) params.append('plant', plant);
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    
    window.location.href = `/admin/reports/client?${params.toString()}`;
    showNotification(`Generating ${type} client report`, 'info');
}

// Template Management Functions - Enhanced with Real Functionality
function uploadTemplate(type) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload ${type.toUpperCase()} Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">Template File</label>
                            <input type="file" class="form-control" id="templateFile" 
                                   accept="${getFileTypes(type)}" required>
                            <div class="form-text">Accepted formats: ${getFileTypesText(type)}</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Template Name</label>
                            <input type="text" class="form-control" id="templateName" 
                                   placeholder="Enter a descriptive name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="templateDescription" rows="2" 
                                      placeholder="Brief description of template usage"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="templateCategory">
                                <option value="reports">Report Templates</option>
                                <option value="emails">Email Templates</option>
                                <option value="branding">Branding Assets</option>
                                <option value="presentations">Presentation Templates</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="processUpload('${type}')">Upload Template</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    new bootstrap.Modal(modal).show();
}

function getFileTypes(type) {
    const types = {
        'ppt': '.ppt,.pptx',
        'pdf': '.pdf',
        'excel': '.xls,.xlsx',
        'image': '.jpg,.jpeg,.png,.svg',
        'doc': '.doc,.docx'
    };
    return types[type] || '.pdf,.ppt,.pptx,.doc,.docx';
}

function getFileTypesText(type) {
    const types = {
        'ppt': 'PowerPoint files (.ppt, .pptx)',
        'pdf': 'PDF files (.pdf)',
        'excel': 'Excel files (.xls, .xlsx)',
        'image': 'Image files (.jpg, .png, .svg)',
        'doc': 'Word documents (.doc, .docx)'
    };
    return types[type] || 'Office files (.pdf, .ppt, .doc, .xls)';
}

function processUpload(type) {
    const file = document.getElementById('templateFile').files[0];
    const name = document.getElementById('templateName').value;
    const description = document.getElementById('templateDescription').value;
    const category = document.getElementById('templateCategory').value;
    
    if (!file || !name.trim()) {
        showNotification('Please select a file and enter a template name', 'error');
        return;
    }
    
    // Simulate upload process
    const progressContainer = document.querySelector('.modal-body');
    progressContainer.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Uploading...</span>
            </div>
            <h6>Uploading ${name}...</h6>
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
    `;
    
    // Simulate progress
    let progress = 0;
    const progressBar = document.querySelector('.progress-bar');
    const interval = setInterval(() => {
        progress += Math.random() * 30;
        if (progress >= 100) {
            progress = 100;
            clearInterval(interval);
            setTimeout(() => {
                const modalElement = document.querySelector('.modal.show');
                bootstrap.Modal.getInstance(modalElement).hide();
                showNotification(`${name} uploaded successfully`, 'success');
                addToAssetsList(name, type, category, file.size);
            }, 500);
        }
        progressBar.style.width = progress + '%';
    }, 200);
}

function addToAssetsList(name, type, category, size) {
    // Add to templates list in the interface
    const assetsList = document.querySelector('#currentAssets .list-group');
    if (assetsList) {
        const newAsset = document.createElement('div');
        newAsset.className = 'list-group-item d-flex justify-content-between align-items-center';
        newAsset.innerHTML = `
            <div>
                <strong>${name}</strong><br>
                <small class="text-muted">${category} - ${(size / 1024).toFixed(1)} KB</small>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" onclick="previewAsset('${name}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-danger" onclick="deleteAsset('${name}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        assetsList.appendChild(newAsset);
    }
}

function deleteAsset(filename) {
    if (confirm(`Are you sure you want to delete ${filename}? This action cannot be undone.`)) {
        // Find and remove the asset from the list
        const assetElements = document.querySelectorAll('.list-group-item');
        assetElements.forEach(element => {
            if (element.textContent.includes(filename)) {
                element.remove();
            }
        });
        showNotification(`${filename} deleted successfully`, 'success');
    }
}

function previewAsset(filename) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Asset Preview: ${filename}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="bg-light p-4 rounded">
                        <i class="fas fa-file-pdf fa-4x text-primary mb-3"></i>
                        <h6>${filename}</h6>
                        <p class="text-muted">Preview functionality available for supported file types</p>
                        <div class="mt-3">
                            <button class="btn btn-primary me-2" onclick="downloadAsset('${filename}')">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                            <button class="btn btn-outline-secondary" onclick="openAssetEditor('${filename}')">
                                <i class="fas fa-edit me-1"></i>Edit Properties
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    new bootstrap.Modal(modal).show();
}

function downloadAsset(filename) {
    showNotification(`Downloading ${filename}...`, 'info');
    // Simulate download
    setTimeout(() => {
        showNotification(`${filename} downloaded successfully`, 'success');
    }, 1000);
}

function openAssetEditor(filename) {
    showNotification(`Opening editor for ${filename}`, 'info');
}

// Settings Functions - Enhanced with Real Functionality
function updateUserRole(userId, newRole) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update User Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Current Role</label>
                        <input type="text" class="form-control" value="${newRole}" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Role</label>
                        <select class="form-select" id="newUserRole">
                            <option value="admin">Administrator</option>
                            <option value="mentor">Mentor/Coach</option>
                            <option value="client">Client View</option>
                            <option value="viewer">Read Only</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Effective Date</label>
                        <input type="date" class="form-control" id="effectiveDate" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Role changes take effect immediately and will require the user to log in again.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmRoleUpdate(${userId})">Update Role</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    new bootstrap.Modal(modal).show();
}

function confirmRoleUpdate(userId) {
    const newRole = document.getElementById('newUserRole').value;
    const effectiveDate = document.getElementById('effectiveDate').value;
    
    // Close modal
    const modalElement = document.querySelector('.modal.show');
    bootstrap.Modal.getInstance(modalElement).hide();
    
    // Show confirmation
    showNotification(`User role updated to ${newRole} (effective ${effectiveDate})`, 'success');
    
    // Update the UI
    const roleElement = document.querySelector(`[data-user-id="${userId}"] .role-badge`);
    if (roleElement) {
        roleElement.textContent = newRole.toUpperCase();
        roleElement.className = `badge bg-${getRoleColor(newRole)} role-badge`;
    }
}

function getRoleColor(role) {
    const colors = {
        'admin': 'danger',
        'mentor': 'warning', 
        'client': 'primary',
        'viewer': 'secondary'
    };
    return colors[role] || 'secondary';
}

function saveSystemPreferences() {
    const timezone = document.querySelector('select[name="timezone"]')?.value;
    const dateFormat = document.querySelector('select[name="dateFormat"]')?.value;
    const namingConvention = document.querySelector('input[name="namingConvention"]')?.value;
    const autoBackup = document.querySelector('input[name="autoBackup"]')?.checked;
    const sessionTimeout = document.querySelector('select[name="sessionTimeout"]')?.value;
    
    // Simulate saving to backend
    const saveButton = event.target;
    const originalText = saveButton.innerHTML;
    
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
    saveButton.disabled = true;
    
    setTimeout(() => {
        saveButton.innerHTML = '<i class="fas fa-check me-1"></i>Saved!';
        showNotification('System preferences saved successfully', 'success');
        
        setTimeout(() => {
            saveButton.innerHTML = originalText;
            saveButton.disabled = false;
        }, 2000);
    }, 1500);
}

function updateReminderSchedule() {
    const enabled = document.getElementById('enableReminders')?.checked;
    const firstReminder = document.querySelector('select[name="firstReminder"]')?.value;
    const interval = document.querySelector('select[name="followupInterval"]')?.value;
    const maxReminders = document.querySelector('select[name="maxReminders"]')?.value;
    
    const settings = {
        enabled: enabled,
        firstReminder: firstReminder,
        interval: interval,
        maxReminders: maxReminders
    };
    
    // Simulate API call
    showNotification('Updating reminder schedule...', 'info');
    
    setTimeout(() => {
        showNotification('Email reminder schedule updated successfully', 'success');
        
        // Update the status display
        const statusElement = document.getElementById('reminderStatus');
        if (statusElement) {
            statusElement.innerHTML = enabled ? 
                '<span class="badge bg-success">Enabled</span>' : 
                '<span class="badge bg-secondary">Disabled</span>';
        }
    }, 1000);
}

function testEmailConfiguration() {
    showNotification('Testing email configuration...', 'info');
    
    // Simulate email test
    setTimeout(() => {
        // Check if email is configured (this would be a real API call)
        const isConfigured = Math.random() > 0.5; // Random for demo
        
        if (isConfigured) {
            showNotification('Email configuration test successful!', 'success');
        } else {
            showNotification('Email configuration failed. Please check SMTP settings.', 'error');
        }
    }, 2000);
}

function exportAuditLog() {
    showNotification('Generating audit log export...', 'info');
    
    setTimeout(() => {
        // Simulate file download
        const link = document.createElement('a');
        link.href = 'data:text/csv;charset=utf-8,Date,User,Action,Details\n2025-07-12,admin,Login,Successful login\n2025-07-12,admin,Export,Data exported';
        link.download = `audit_log_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        showNotification('Audit log exported successfully', 'success');
    }, 1500);
}

// Mentor/Coach View Functions (Role-Based)
function switchToMentorView() {
    // This would redirect to a simplified mentor dashboard
    window.location.href = '/mentor/dashboard';
}

function assignGroupToMentor(mentorId, groupId) {
    showNotification(`Group assigned to mentor successfully`, 'success');
}

function addQualitativeNote(groupId) {
    const note = prompt('Enter your observation for this group:');
    if (note) {
        showNotification('Qualitative note added successfully', 'success');
    }
}

// Enhanced Export Functions
function exportWithFilters() {
    const reportType = document.getElementById('reportScope')?.value || 'all';
    const format = document.getElementById('reportFormat')?.value || 'excel';
    const dateFrom = document.getElementById('fromDate')?.value;
    const dateTo = document.getElementById('toDate')?.value;
    
    const params = new URLSearchParams({
        type: reportType,
        format: format
    });
    
    if (dateFrom) params.append('date_from', dateFrom);
    if (dateTo) params.append('date_to', dateTo);
    
    window.location.href = `/admin/export/filtered?${params.toString()}`;
    showNotification('Exporting filtered data', 'info');
}

// Download Queue Management
function checkDownloadStatus() {
    // Check if there are any pending downloads
    fetch('/admin/download-status')
        .then(response => response.json())
        .then(data => {
            if (data.pending > 0) {
                showNotification(`${data.pending} downloads in queue`, 'info');
            }
        })
        .catch(error => console.error('Error checking download status:', error));
}

// Initialize download status check
setInterval(checkDownloadStatus, 30000); // Check every 30 seconds

// Enhanced Report Functions
function updateReportOptions() {
    const reportType = document.getElementById('reportType').value;
    const formatSelect = document.getElementById('reportFormat');
    
    // Update format options based on report type
    formatSelect.innerHTML = '';
    
    if (reportType === 'individual') {
        formatSelect.innerHTML = `
            <option value="pdf">PDF</option>
            <option value="docx">Word Document</option>
        `;
    } else if (reportType === 'group') {
        formatSelect.innerHTML = `
            <option value="ppt">PowerPoint</option>
            <option value="pdf">PDF</option>
            <option value="excel">Excel</option>
        `;
    } else if (reportType === 'summary') {
        formatSelect.innerHTML = `
            <option value="pdf">PDF Dashboard</option>
            <option value="ppt">Executive PPT</option>
            <option value="excel">Data Summary</option>
        `;
    }
    
    showNotification(`Updated options for ${reportType} reports`, 'info');
}

function refreshDownloadQueue() {
    // Simulate refresh of download queue
    const progressBars = document.querySelectorAll('.progress-bar-animated');
    progressBars.forEach(bar => {
        const currentWidth = parseInt(bar.style.width);
        if (currentWidth < 100) {
            bar.style.width = Math.min(currentWidth + 10, 100) + '%';
        }
    });
    
    showNotification('Download queue refreshed', 'info');
}

function resetReportForm() {
    document.getElementById('reportGenerationForm').reset();
    document.getElementById('individualParticipantDiv').style.display = 'none';
    showNotification('Report form reset', 'info');
}

// Additional missing functions - removed duplicate processUpload

function editRole(roleId) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editRoleForm">
                        <div class="mb-3">
                            <label class="form-label">Role Name</label>
                            <input type="text" class="form-control" id="editRoleName" value="Admin" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Permissions</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editViewReports" checked>
                                <label class="form-check-label">View Reports</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editManageUsers" checked>
                                <label class="form-check-label">Manage Users</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editSystemSettings" checked>
                                <label class="form-check-label">System Settings</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedRole('${roleId}')">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    new bootstrap.Modal(modal).show();
}

function saveEditedRole(roleId) {
    const roleName = document.getElementById('editRoleName').value;
    showNotification(`Role ${roleName} updated successfully`, 'success');
    const modalElement = document.querySelector('.modal.show');
    if (modalElement) {
        bootstrap.Modal.getInstance(modalElement).hide();
    }
}

function addNewRole() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newRoleForm">
                        <div class="mb-3">
                            <label class="form-label">Role Name</label>
                            <input type="text" class="form-control" id="newRoleName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Permissions</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newViewReports">
                                <label class="form-check-label">View Reports</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newManageUsers">
                                <label class="form-check-label">Manage Users</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="newSystemSettings">
                                <label class="form-check-label">System Settings</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewRole()">Add Role</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    new bootstrap.Modal(modal).show();
}

function saveNewRole() {
    const roleName = document.getElementById('newRoleName').value;
    if (!roleName.trim()) {
        showNotification('Please enter a role name', 'error');
        return;
    }
    showNotification(`Role ${roleName} created successfully`, 'success');
    const modalElement = document.querySelector('.modal.show');
    if (modalElement) {
        bootstrap.Modal.getInstance(modalElement).hide();
    }
}
</script>

</div>
</div>

<!-- Premium Dashboard Styles -->
<style>
    /* Premium Navigation Styling */
    .premium-nav-link {
        border: none !important;
        background: transparent !important;
        color: #6c757d !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        padding: 1rem 1.5rem !important;
        border-radius: 12px !important;
        margin: 0 0.25rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        min-height: 80px;
        justify-content: center;
    }

    .premium-nav-link:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .premium-nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        transform: translateY(-1px);
    }

    .nav-icon-container {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        opacity: 0.8;
    }

    .nav-text {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .nav-indicator {
        position: absolute;
        bottom: -2px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 3px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 2px;
        transition: width 0.3s ease;
    }

    .premium-nav-link.active .nav-indicator,
    .premium-nav-link:hover .nav-indicator {
        width: 80%;
    }

    /* Premium KPI Cards */
    .premium-kpi-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 16px !important;
        overflow: hidden;
        position: relative;
    }

    .premium-kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        pointer-events: none;
    }

    .premium-kpi-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15) !important;
    }

    .premium-icon-wrapper {
        position: relative;
        display: inline-block;
    }

    .premium-icon-wrapper::before {
        content: '';
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        z-index: 0;
    }

    .premium-icon-wrapper i {
        position: relative;
        z-index: 1;
    }

    /* Enhanced Tables */
    .table-responsive table {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    }

    .table th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.75rem;
        padding: 1rem;
        border: none;
    }

    .table td {
        padding: 1rem;
        border: none;
        vertical-align: middle;
    }

    .table tbody tr:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }

    /* Premium Progress Bars */
    .progress {
        border-radius: 10px;
        background: rgba(255,255,255,0.2);
        overflow: hidden;
    }

    .progress-bar {
        border-radius: 10px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        position: relative;
        overflow: hidden;
    }

    .progress-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    /* Ranking Panel Styles */
    .ranking-list {
        max-height: 150px;
        overflow-y: auto;
    }
    
    .ranking-item {
        transition: all 0.3s ease;
        background: white;
    }
    
    .ranking-item:hover {
        background: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .ranking-number {
        font-size: 1.2rem;
        width: 30px;
        text-align: center;
    }
    
    .practice-name {
        color: #2c3e50;
        line-height: 1.2;
    }
    
    .ranking-item .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }

    /* Premium Cards */
    .card {
        border-radius: 16px !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
        box-shadow: 0 12px 28px rgba(0,0,0,0.12) !important;
        transform: translateY(-2px);
    }

    .card-header {
        border-radius: 16px 16px 0 0 !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%) !important;
    }

    /* Premium Badges */
    .badge {
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .bg-dark {
        background: linear-gradient(135deg, #343a40 0%, #495057 100%) !important;
    }

    .bg-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
    }

    /* Real-time Updates */
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    .real-time-indicator {
        animation: pulse 2s infinite;
    }

    /* Glassmorphism Effect */
    .glass-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
    }

    /* Smooth Scrolling */
    .tab-content {
        scroll-behavior: smooth;
    }

    /* Enhanced Header Styles */
    .premium-header {
        position: relative;
        overflow: hidden;
        min-height: 180px;
        display: flex;
        align-items: center;
    }
    
    .premium-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 80%, rgba(255,255,255,0.1) 0%, transparent 50%);
        pointer-events: none;
    }
    
    /* Pulse Animation */
    @keyframes pulse {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
        100% { opacity: 1; transform: scale(1); }
    }
    
    /* Spin Animation */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    /* Enhanced Badges */
    .status-badge {
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
    }
    
    .status-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
        .premium-nav-link {
            min-height: 60px;
            padding: 0.75rem 1rem !important;
        }
        
        .nav-text {
            font-size: 0.75rem;
        }
        
        .premium-kpi-card {
            margin-bottom: 1.5rem;
        }
        
        .display-6 {
            font-size: 2rem !important;
        }
        
        .premium-header {
            padding: 1.5rem 1rem !important;
            min-height: 140px;
        }
        
        .premium-header h1 {
            font-size: 1.5rem !important;
        }
    }
</style>

<script>
    // Premium Dashboard JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // Real-time clock update
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit'
            });
            const element = document.getElementById('lastUpdate');
            if (element) {
                element.textContent = timeString;
            }
        }
        
        // Update clock every second
        setInterval(updateClock, 1000);
        updateClock();
        
        // Enhanced tab switching with animations
        const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabButtons.forEach(button => {
            button.addEventListener('shown.bs.tab', function(e) {
                const targetPane = document.querySelector(e.target.getAttribute('data-bs-target'));
                if (targetPane) {
                    targetPane.style.opacity = '0';
                    targetPane.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        targetPane.style.transition = 'all 0.3s ease';
                        targetPane.style.opacity = '1';
                        targetPane.style.transform = 'translateY(0)';
                    }, 50);
                }
            });
        });
        
        // KPI card hover effects
        const kpiCards = document.querySelectorAll('.premium-kpi-card');
        kpiCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-8px) scale(1.02)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
            });
        });
        
        // Loading states for buttons
        function addLoadingState(button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            button.disabled = true;
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
        
        // Attach to export buttons
        document.querySelectorAll('[onclick*="export"]').forEach(btn => {
            btn.addEventListener('click', function() {
                addLoadingState(this);
            });
        });
        
        // Initialize Analytics Charts
        initializeAnalyticsCharts();
    });
    
    // Analytics Charts Initialization
    function initializeAnalyticsCharts() {
        // Data variables for all charts
        const totalParticipants = {{ total_pledges }};
        const completedSurveys = {{ total_surveys }};
        const pendingSurveys = totalParticipants - completedSurveys;
        const completionRate = totalParticipants > 0 ? ((completedSurveys / totalParticipants) * 100).toFixed(1) : 0;
        const highImpact = {{ practice_stats.HIGH|default(0) }};
        const mediumImpact = {{ practice_stats.MEDIUM|default(0) }};
        const lowImpact = {{ practice_stats.LOW|default(0) }};
        
        // Load user details tables

        
        // Survey Completion Status - Doughnut Chart
        const completionCtx = document.getElementById('surveyCompletionChart');
        if (completionCtx) {
            
            new Chart(completionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending'],
                    datasets: [{
                        data: [completedSurveys, pendingSurveys],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107'
                        ],
                        borderColor: [
                            '#ffffff',
                            '#ffffff'
                        ],
                        borderWidth: 3,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const percentage = totalParticipants > 0 ? ((value / totalParticipants) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // Participant Engagement Overview - Mixed Chart
        const engagementCtx = document.getElementById('engagementOverviewChart');
        if (engagementCtx) {
            
            new Chart(engagementCtx, {
                type: 'bar',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6', 'Current'],
                    datasets: [
                        {
                            label: 'Survey Submissions',
                            type: 'line',
                            data: [3, 7, 12, 18, 22, 28, completedSurveys],
                            borderColor: 'rgba(240, 147, 251, 1)',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: 'rgba(240, 147, 251, 1)',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        },
                        {
                            label: 'High Impact Practices',
                            data: [1, 2, 3, 4, 5, 6, highImpact],
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 2,
                            borderRadius: 6
                        },
                        {
                            label: 'Medium Impact Practices',
                            data: [0, 1, 2, 2, 3, 3, mediumImpact],
                            backgroundColor: 'rgba(255, 193, 7, 0.7)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 2,
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 11,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 10
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 10,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Completion Progress - Gauge-style Doughnut Chart
        const progressCtx = document.getElementById('completionProgressChart');
        if (progressCtx) {
            const completionPercentage = totalParticipants > 0 ? ((completedSurveys / totalParticipants) * 100) : 0;
            const remaining = 100 - completionPercentage;
            
            new Chart(progressCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Remaining'],
                    datasets: [{
                        data: [completionPercentage, remaining],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(240, 240, 240, 0.3)'
                        ],
                        borderColor: [
                            'rgba(102, 126, 234, 1)',
                            'rgba(200, 200, 200, 0.5)'
                        ],
                        borderWidth: 2,
                        cutout: '75%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    rotation: -90,
                    circumference: 180,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataIndex === 0) {
                                        return `Completion: ${completionPercentage.toFixed(1)}%`;
                                    }
                                    return `Remaining: ${remaining.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                        const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2 + 20;
                        
                        ctx.save();
                        ctx.font = 'bold 24px Arial';
                        ctx.fillStyle = 'rgba(102, 126, 234, 1)';
                        ctx.textAlign = 'center';
                        ctx.fillText(`${completionPercentage.toFixed(1)}%`, centerX, centerY);
                        
                        ctx.font = '12px Arial';
                        ctx.fillStyle = '#666';
                        ctx.fillText('Completion Rate', centerX, centerY + 25);
                        ctx.restore();
                    }
                }]
            });
        }
    }

    // Edit Participant Function
    function editParticipant(userId) {
        // Fetch participant data
        fetch(`/admin/participant/${userId}/details`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate modal with current data
                    document.getElementById('editUserId').value = userId;
                    document.getElementById('editParticipantName').value = data.participant.name || '';
                    document.getElementById('editParticipantEmail').value = data.participant.email || '';
                    document.getElementById('editParticipantPhone').value = data.participant.phone || '';
                    document.getElementById('editParticipantEmployeeId').value = data.participant.employee_id || '';
                    document.getElementById('editParticipantDesignation').value = data.participant.designation || '';
                    
                    // Show modal
                    const editModal = new bootstrap.Modal(document.getElementById('editParticipantModal'));
                    editModal.show();
                } else {
                    showNotification('Error loading participant data: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error loading participant data', 'error');
            });
    }

    // Simplified Report Export Functions
    function exportExcelReport() {
        showNotification('Generating Excel report with complete analytics...', 'info');
        
        // Navigate to existing Excel export
        window.location.href = '/export-data';
    }
    
    function exportPDFReport() {
        showNotification('Generating PDF summary report...', 'info');
        
        // Generate analytics PDF report
        window.location.href = '/admin/generate-custom-report?type=analytics&format=pdf';
    }
    
    function exportVisualReport() {
        showNotification('Generating visual analytics report...', 'info');
        
        // Create a visual report with charts embedded
        generateVisualAnalyticsReport();
    }
    
    function generateVisualAnalyticsReport() {
        // Create a visual report with simple redirect to analytics page
        showNotification('Opening visual analytics report...', 'info');
        
        // Open the admin dashboard analytics tab in a new window
        const reportUrl = window.location.origin + '/admin/dashboard#analytics';
        window.open(reportUrl, '_blank', 'width=1200,height=800');
    }
    
    function downloadComprehensivePPT() {
        showNotification('Generating comprehensive PowerPoint with all participant data and charts...', 'info');
        window.location.href = '/admin/generate-comprehensive-ppt';
    }
    


    function exportPPTWithCharts(type) {
        showNotification('Generating ' + type + ' PowerPoint presentation with charts...', 'info');
        
        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        button.disabled = true;
        
        // Generate PPT with embedded charts
        fetch('/admin/generate-ppt-with-charts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                type: type,
                charts: {
                    completion: {
                        completed: {{ total_surveys }},
                        pending: {{ total_pledges }} - {{ total_surveys }}
                    },
                    practice_stats: {{ practice_stats|tojson }}
                }
            })
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Failed to generate PowerPoint');
        })
        .then(blob => {
            // Download the PPT file
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `digital_culture_${type}_report_${new Date().toISOString().split('T')[0]}.pptx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('PowerPoint report with charts generated successfully!', 'success');
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error generating PowerPoint report', 'error');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    // Save Participant Changes
    function saveParticipantChanges() {
        const userId = document.getElementById('editUserId').value;
        const formData = {
            name: document.getElementById('editParticipantName').value.trim(),
            email: document.getElementById('editParticipantEmail').value.trim(),
            phone: document.getElementById('editParticipantPhone').value.trim(),
            employee_id: document.getElementById('editParticipantEmployeeId').value.trim(),
            designation: document.getElementById('editParticipantDesignation').value.trim()
        };

        // Validate required fields
        if (!formData.name || !formData.email) {
            showNotification('Name and email are required fields', 'error');
            return;
        }

        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(formData.email)) {
            showNotification('Please enter a valid email address', 'error');
            return;
        }

        // Validate phone number if provided
        if (formData.phone && !/^[\d\-\+\(\)\s]{10,15}$/.test(formData.phone.replace(/\s/g, ''))) {
            showNotification('Please enter a valid phone number (10-15 digits)', 'error');
            return;
        }

        // Show loading state
        const saveBtn = document.getElementById('saveParticipantBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        saveBtn.disabled = true;

        // Send update request
        fetch(`/admin/participant/${userId}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Participant updated successfully!', 'success');
                
                // Close modal
                const editModal = bootstrap.Modal.getInstance(document.getElementById('editParticipantModal'));
                editModal.hide();
                
                // Refresh page to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification('Error updating participant: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error updating participant', 'error');
        })
        .finally(() => {
            // Restore button state
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
    }
</script>

<!-- Edit Participant Modal -->
<div class="modal fade" id="editParticipantModal" tabindex="-1" aria-labelledby="editParticipantModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editParticipantModalLabel">
                    <i class="fas fa-user-edit me-2"></i>
                    Edit Participant Information
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editParticipantForm">
                    <input type="hidden" id="editUserId" value="">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editParticipantName" class="form-label fw-bold">
                                    <i class="fas fa-user me-1"></i>Full Name *
                                </label>
                                <input type="text" class="form-control" id="editParticipantName" required>
                                <div class="form-text">Enter participant's full name</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editParticipantEmail" class="form-label fw-bold">
                                    <i class="fas fa-envelope me-1"></i>Email Address *
                                </label>
                                <input type="email" class="form-control" id="editParticipantEmail" required>
                                <div class="form-text">Valid email address for communication</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editParticipantPhone" class="form-label fw-bold">
                                    <i class="fas fa-phone me-1"></i>Phone Number
                                </label>
                                <input type="tel" class="form-control" id="editParticipantPhone" placeholder="e.g., +91 9876543210">
                                <div class="form-text">10-15 digit phone number (optional)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editParticipantEmployeeId" class="form-label fw-bold">
                                    <i class="fas fa-id-badge me-1"></i>Employee ID
                                </label>
                                <input type="text" class="form-control" id="editParticipantEmployeeId" placeholder="e.g., EMP001">
                                <div class="form-text">Unique employee identifier</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editParticipantDesignation" class="form-label fw-bold">
                            <i class="fas fa-briefcase me-1"></i>Designation/Role
                        </label>
                        <input type="text" class="form-control" id="editParticipantDesignation" placeholder="e.g., Digital Transformation Specialist">
                        <div class="form-text">Current job title or role</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Changes to participant information will be reflected across all reports and surveys. 
                        Please ensure accuracy before saving.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveParticipantBtn" onclick="saveParticipantChanges()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cohort Report Modal -->
<div class="modal fade" id="cohortReportModal" tabindex="-1" aria-labelledby="cohortReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title" id="cohortReportModalLabel">
                    <i class="fas fa-chart-bar me-2"></i>Generate Comprehensive Cohort Report
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Report Type Selection -->
                <div class="cohort-filter-card">
                    <h6 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Report Type</h6>
                    <div class="report-type-selector">
                        <div class="report-type-card" data-type="summary" onclick="selectReportType('summary')">
                            <i class="fas fa-chart-pie fa-2x mb-2" style="color: #667eea;"></i>
                            <h6>Summary Report</h6>
                            <small class="text-muted">Overview with key metrics and charts</small>
                        </div>
                        <div class="report-type-card" data-type="detailed" onclick="selectReportType('detailed')">
                            <i class="fas fa-file-alt fa-2x mb-2" style="color: #28a745;"></i>
                            <h6>Detailed Report</h6>
                            <small class="text-muted">Comprehensive analysis with individual data</small>
                        </div>
                        <div class="report-type-card" data-type="analytics" onclick="selectReportType('analytics')">
                            <i class="fas fa-chart-line fa-2x mb-2" style="color: #dc3545;"></i>
                            <h6>Analytics Report</h6>
                            <small class="text-muted">Statistical analysis and trends</small>
                        </div>
                    </div>
                </div>

                <!-- Cohort Selection -->
                <div class="cohort-filter-card">
                    <h6 class="mb-3"><i class="fas fa-users me-2"></i>Cohort Selection</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Filter by Department</label>
                            <select class="form-select" id="departmentFilter">
                                <option value="all">All Departments</option>
                                <option value="digital">Digital Transformation</option>
                                <option value="operations">Operations</option>
                                <option value="management">Management</option>
                                <option value="technical">Technical</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Filter by Survey Status</label>
                            <select class="form-select" id="surveyStatusFilter">
                                <option value="all">All Participants</option>
                                <option value="completed">Survey Completed</option>
                                <option value="pending">Survey Pending</option>
                                <option value="multiple">Multiple Surveys</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Participant Selection -->
                <div class="cohort-filter-card">
                    <h6 class="mb-3"><i class="fas fa-user-check me-2"></i>Select Participants</h6>
                    <div class="d-flex justify-content-between mb-3">
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllParticipants()">
                                <i class="fas fa-check-double me-1"></i>Select All
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="clearParticipantSelection()">
                                <i class="fas fa-times me-1"></i>Clear All
                            </button>
                        </div>
                        <div>
                            <span class="badge bg-info" id="selectedCount">0 selected</span>
                        </div>
                    </div>
                    <div class="participant-selection" id="participantList">
                        <!-- Participant list will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Report Format Options -->
                <div class="cohort-filter-card">
                    <h6 class="mb-3"><i class="fas fa-file-export me-2"></i>Export Options</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includePDF" checked>
                                <label class="form-check-label">
                                    <i class="fas fa-file-pdf text-danger me-1"></i>PDF Report
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeExcel" checked>
                                <label class="form-check-label">
                                    <i class="fas fa-file-excel text-success me-1"></i>Excel Data
                                </label>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includePPT">
                                <label class="form-check-label">
                                    <i class="fas fa-file-powerpoint text-warning me-1"></i>PowerPoint
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="generateCohortReport()" id="generateReportBtn" disabled>
                    <i class="fas fa-download me-1"></i>Generate Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Cohort Report Functions
function showCohortReportModal() {
    // Load participant list
    loadParticipantList();
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('cohortReportModal'));
    modal.show();
}

function loadParticipantList() {
    // Fetch all participants
    fetch('/admin/participants/list')
        .then(response => response.json())
        .then(data => {
            const participantList = document.getElementById('participantList');
            participantList.innerHTML = '';
            
            data.participants.forEach(participant => {
                const participantDiv = document.createElement('div');
                participantDiv.className = 'participant-checkbox';
                participantDiv.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input participant-select" type="checkbox" 
                               value="${participant.id}" id="participant_${participant.id}">
                        <label class="form-check-label" for="participant_${participant.id}">
                            <strong>${participant.name}</strong> - ${participant.email}
                            <br><small class="text-muted">${participant.designation || 'No designation'} | 
                            ${participant.survey_responses && participant.survey_responses.length > 0 ? participant.survey_responses.length + ' surveys' : 'No surveys'}</small>
                        </label>
                    </div>
                `;
                participantList.appendChild(participantDiv);
            });
            
            updateSelectedCount();
        })
        .catch(error => {
            console.error('Error loading participants:', error);
            showNotification('Error loading participant list', 'error');
        });
}

function selectReportType(type) {
    // Remove selected class from all cards
    document.querySelectorAll('.report-type-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selected class to clicked card
    document.querySelector(`[data-type="${type}"]`).classList.add('selected');
    
    // Update generate button
    const generateBtn = document.getElementById('generateReportBtn');
    generateBtn.disabled = false;
    generateBtn.setAttribute('data-report-type', type);
}

function selectAllParticipants() {
    const checkboxes = document.querySelectorAll('.participant-select');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedCount();
}

function clearParticipantSelection() {
    const checkboxes = document.querySelectorAll('.participant-select');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const selectedCheckboxes = document.querySelectorAll('.participant-select:checked');
    const count = selectedCheckboxes.length;
    document.getElementById('selectedCount').textContent = `${count} selected`;
    
    // Add event listeners to update count when checkboxes change
    document.querySelectorAll('.participant-select').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
}

function generateCohortReport() {
    const reportType = document.getElementById('generateReportBtn').getAttribute('data-report-type');
    const selectedParticipants = Array.from(document.querySelectorAll('.participant-select:checked')).map(cb => cb.value);
    const departmentFilter = document.getElementById('departmentFilter').value;
    const surveyStatusFilter = document.getElementById('surveyStatusFilter').value;
    const includePDF = document.getElementById('includePDF').checked;
    const includeExcel = document.getElementById('includeExcel').checked;
    const includePPT = document.getElementById('includePPT').checked;
    
    if (!reportType) {
        showNotification('Please select a report type', 'error');
        return;
    }
    
    if (selectedParticipants.length === 0) {
        showNotification('Please select at least one participant', 'error');
        return;
    }
    
    if (!includePDF && !includeExcel && !includePPT) {
        showNotification('Please select at least one export format', 'error');
        return;
    }
    
    // Show loading state
    const generateBtn = document.getElementById('generateReportBtn');
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
    generateBtn.disabled = true;
    
    // Prepare request data
    const requestData = {
        report_type: reportType,
        participants: selectedParticipants,
        department_filter: departmentFilter,
        survey_status_filter: surveyStatusFilter,
        include_pdf: includePDF,
        include_excel: includeExcel,
        include_ppt: includePPT
    };
    
    // Make API call to generate cohort report
    fetch('/admin/generate-cohort-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (response.ok) {
            // If it's a file download, handle it properly
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/')) {
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    // Determine filename based on report type
                    let filename = `cohort_report_${reportType}_${new Date().toISOString().split('T')[0]}`;
                    if (contentType.includes('pdf')) filename += '.pdf';
                    else if (contentType.includes('excel') || contentType.includes('sheet')) filename += '.xlsx';
                    else if (contentType.includes('zip')) filename += '.zip';
                    else filename += '.pdf';
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showNotification(`${reportType.charAt(0).toUpperCase() + reportType.slice(1)} report generated successfully!`, 'success');
                });
            } else {
                return response.json();
            }
        } else {
            throw new Error('Report generation failed');
        }
    })
    .then(data => {
        if (data && data.success) {
            showNotification(data.message, 'success');
        }
    })
    .catch(error => {
        console.error('Error generating report:', error);
        showNotification('Error generating cohort report', 'error');
    })
    .finally(() => {
        // Reset button state
        generateBtn.innerHTML = '<i class="fas fa-download me-1"></i>Generate Report';
        generateBtn.disabled = false;
        
        // Close modal after successful generation
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('cohortReportModal')).hide();
        }, 2000);
    });
}

// ==================== IMPACT ANALYSIS FUNCTIONS ====================

// Initialize Impact Analysis Charts
function initializeImpactAnalysisCharts() {
    if (document.getElementById('impact-analysis-tab')) {
        setTimeout(() => {
            createImpactDistributionChart();
            createHighImpactChart();

            createWeeklyPracticesChart();
            createMonthlyPracticesChart();
            createQuarterlyPracticesChart();
        }, 500);
    }
}

// Create Impact Distribution Chart
function createImpactDistributionChart() {
    const ctx = document.getElementById('impactDistributionChart');
    if (!ctx) return;

    // Fetch impact data from the API
    fetch('/admin/api/impact-analysis')
        .then(response => response.json())
        .then(data => {
            const chartData = {
                labels: ['Weekly Practices', 'Monthly Practices', 'Quarterly Practices'],
                datasets: [
                    {
                        label: 'HIGH Impact',
                        data: [
                            data.high_impact.weekly.length,
                            data.high_impact.monthly.length,
                            data.high_impact.quarterly.length
                        ],
                        backgroundColor: '#28a745',
                        borderColor: '#1e7e34',
                        borderWidth: 2
                    },
                    {
                        label: 'MEDIUM Impact',
                        data: [
                            data.medium_impact.weekly.length,
                            data.medium_impact.monthly.length,
                            data.medium_impact.quarterly.length
                        ],
                        backgroundColor: '#ffc107',
                        borderColor: '#e0a800',
                        borderWidth: 2
                    },
                    {
                        label: 'LOW Impact',
                        data: [
                            data.low_impact.weekly.length,
                            data.low_impact.monthly.length,
                            data.low_impact.quarterly.length
                        ],
                        backgroundColor: '#dc3545',
                        borderColor: '#c82333',
                        borderWidth: 2
                    }
                ]
            };

            new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Impact Distribution Across Practice Types'
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading impact analysis data:', error);
        });
}

// Create High Impact Users Chart
function createHighImpactChart() {
    const ctx = document.getElementById('highImpactChart');
    if (!ctx) return;

    fetch('/admin/api/impact-analysis')
        .then(response => response.json())
        .then(data => {
            const chartData = {
                labels: ['Weekly', 'Monthly', 'Quarterly'],
                datasets: [{
                    label: 'High Impact Users',
                    data: [
                        data.high_impact.weekly.length,
                        data.high_impact.monthly.length,
                        data.high_impact.quarterly.length
                    ],
                    backgroundColor: [
                        '#dc3545',
                        '#ffc107',
                        '#6f42c1'
                    ],
                    borderColor: [
                        '#c82333',
                        '#e0a800',
                        '#5a32a3'
                    ],
                    borderWidth: 3
                }]
            };

            new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'High Impact Users by Practice Type'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading high impact chart data:', error);
        });
}



// Create Popular Practices Chart
function createPopularPracticesChart() {
    const ctx = document.getElementById('popularPracticesChart');
    if (!ctx) return;

    fetch('/admin/api/impact-analysis')
        .then(response => response.json())
        .then(data => {
            if (!data.practice_popularity) {
                console.warn('No practice popularity data available');
                return;
            }

            // Combine all practices and get top 10 most popular
            let allPractices = [];
            
            // Process weekly practices
            Object.entries(data.practice_popularity.weekly_practices || {}).forEach(([practice, stats]) => {
                if (practice !== 'Not specified' && stats.total > 0) {
                    allPractices.push({
                        practice: practice,
                        type: 'Weekly',
                        total: stats.total,
                        high: stats.HIGH || 0,
                        medium: stats.MEDIUM || 0,
                        low: stats.LOW || 0
                    });
                }
            });
            
            // Process monthly practices
            Object.entries(data.practice_popularity.monthly_practices || {}).forEach(([practice, stats]) => {
                if (practice !== 'Not specified' && stats.total > 0) {
                    allPractices.push({
                        practice: practice,
                        type: 'Monthly',
                        total: stats.total,
                        high: stats.HIGH || 0,
                        medium: stats.MEDIUM || 0,
                        low: stats.LOW || 0
                    });
                }
            });
            
            // Process quarterly practices
            Object.entries(data.practice_popularity.quarterly_practices || {}).forEach(([practice, stats]) => {
                if (practice !== 'Not specified' && stats.total > 0) {
                    allPractices.push({
                        practice: practice,
                        type: 'Quarterly',
                        total: stats.total,
                        high: stats.HIGH || 0,
                        medium: stats.MEDIUM || 0,
                        low: stats.LOW || 0
                    });
                }
            });
            
            // Sort by total usage and take top 10
            allPractices.sort((a, b) => b.total - a.total);
            const topPractices = allPractices.slice(0, 10);
            
            // Prepare chart data
            const labels = topPractices.map(p => {
                const shortPractice = p.practice.length > 30 ? p.practice.substring(0, 30) + '...' : p.practice;
                return `${shortPractice} (${p.type})`;
            });
            
            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'HIGH Impact',
                        data: topPractices.map(p => p.high),
                        backgroundColor: '#28a745',
                        borderColor: '#1e7e34',
                        borderWidth: 1
                    },
                    {
                        label: 'MEDIUM Impact',
                        data: topPractices.map(p => p.medium),
                        backgroundColor: '#ffc107',
                        borderColor: '#e0a800',
                        borderWidth: 1
                    },
                    {
                        label: 'LOW Impact',
                        data: topPractices.map(p => p.low),
                        backgroundColor: '#dc3545',
                        borderColor: '#c82333',
                        borderWidth: 1
                    }
                ]
            };

            new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Most Popular Practices by Impact Level'
                        },
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    return topPractices[index].practice;
                                },
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const practice = topPractices[index];
                                    return [
                                        `Type: ${practice.type}`,
                                        `Total Users: ${practice.total}`,
                                        `Success Rate: ${((practice.high / practice.total) * 100).toFixed(1)}%`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
            
            // Update practice details panel
            updatePracticeDetailsPanel(topPractices);
        })
        .catch(error => {
            console.error('Error loading popular practices chart:', error);
        });
}

// Create Weekly Practices Chart
function createWeeklyPracticesChart() {
    const ctx = document.getElementById('weeklyPracticesChart');
    if (!ctx) {
        console.error('Weekly chart canvas not found');
        return;
    }

    fetch('/admin/api/impact-analysis')
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch data');
            return response.json();
        })
        .then(data => {
            console.log('Weekly chart data:', data);
            
            if (!data.practice_popularity || !data.practice_popularity.weekly_practices) {
                console.warn('No weekly practices data available');
                // Create empty chart
                createEmptyChart(ctx, 'Weekly Practices - No Data Available');
                return;
            }

            const practices = Object.entries(data.practice_popularity.weekly_practices)
                .filter(([practice, stats]) => practice !== 'Not specified' && stats.total > 0)
                .sort(([,a], [,b]) => b.total - a.total)
                .slice(0, 5);

            if (practices.length === 0) {
                createEmptyChart(ctx, 'Weekly Practices - No Survey Data');
                return;
            }

            // Calculate total for percentage
            const totalUsers = practices.reduce((sum, [, stats]) => sum + stats.total, 0);
            
            const labels = practices.map(([practice]) => practice);
            
            const percentages = practices.map(([, stats]) => 
                totalUsers > 0 ? ((stats.total / totalUsers) * 100).toFixed(1) : 0
            );

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Selection %',
                    data: percentages,
                    backgroundColor: '#dc3545',
                    borderColor: '#c82333',
                    borderWidth: 1
                }]
            };

            new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
            
            // Update ranking panel
            updateRankingPanel('weekly', practices, data);
        })
        .catch(error => {
            console.error('Error loading weekly practices chart:', error);
            createEmptyChart(ctx, 'Weekly Practices - Error Loading Data');
        });
}

// Create Monthly Practices Chart
function createMonthlyPracticesChart() {
    const ctx = document.getElementById('monthlyPracticesChart');
    if (!ctx) {
        console.error('Monthly chart canvas not found');
        return;
    }

    fetch('/admin/api/impact-analysis')
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch data');
            return response.json();
        })
        .then(data => {
            console.log('Monthly chart data:', data);
            
            if (!data.practice_popularity || !data.practice_popularity.monthly_practices) {
                console.warn('No monthly practices data available');
                createEmptyChart(ctx, 'Monthly Practices - No Data Available');
                return;
            }

            const practices = Object.entries(data.practice_popularity.monthly_practices)
                .filter(([practice, stats]) => practice !== 'Not specified' && stats.total > 0)
                .sort(([,a], [,b]) => b.total - a.total)
                .slice(0, 5);

            if (practices.length === 0) {
                createEmptyChart(ctx, 'Monthly Practices - No Survey Data');
                return;
            }

            // Calculate total for percentage
            const totalUsers = practices.reduce((sum, [, stats]) => sum + stats.total, 0);
            
            const labels = practices.map(([practice]) => practice);
            
            const percentages = practices.map(([, stats]) => 
                totalUsers > 0 ? ((stats.total / totalUsers) * 100).toFixed(1) : 0
            );

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Selection %',
                    data: percentages,
                    backgroundColor: '#ffc107',
                    borderColor: '#e0a800',
                    borderWidth: 1
                }]
            };

            new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
            
            // Update ranking panel
            updateRankingPanel('monthly', practices, data);
        })
        .catch(error => {
            console.error('Error loading monthly practices chart:', error);
            createEmptyChart(ctx, 'Monthly Practices - Error Loading Data');
        });
}

// Create Quarterly Practices Chart
function createQuarterlyPracticesChart() {
    const ctx = document.getElementById('quarterlyPracticesChart');
    if (!ctx) {
        console.error('Quarterly chart canvas not found');
        return;
    }

    fetch('/admin/api/impact-analysis')
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch data');
            return response.json();
        })
        .then(data => {
            console.log('Quarterly chart data:', data);
            
            if (!data.practice_popularity || !data.practice_popularity.quarterly_practices) {
                console.warn('No quarterly practices data available');
                createEmptyChart(ctx, 'Quarterly Practices - No Data Available');
                return;
            }

            const practices = Object.entries(data.practice_popularity.quarterly_practices)
                .filter(([practice, stats]) => practice !== 'Not specified' && stats.total > 0)
                .sort(([,a], [,b]) => b.total - a.total)
                .slice(0, 5);

            if (practices.length === 0) {
                createEmptyChart(ctx, 'Quarterly Practices - No Survey Data');
                return;
            }

            // Calculate total for percentage
            const totalUsers = practices.reduce((sum, [, stats]) => sum + stats.total, 0);
            
            const labels = practices.map(([practice]) => practice);
            
            const percentages = practices.map(([, stats]) => 
                totalUsers > 0 ? ((stats.total / totalUsers) * 100).toFixed(1) : 0
            );

            const chartData = {
                labels: labels,
                datasets: [{
                    label: 'Selection %',
                    data: percentages,
                    backgroundColor: '#6f42c1',
                    borderColor: '#5a32a3',
                    borderWidth: 1
                }]
            };

            new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    layout: {
                        padding: {
                            top: 5,
                            bottom: 5,
                            left: 5,
                            right: 5
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: { size: 10 }
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 10 }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: false }
                    }
                }
            });
            
            // Update ranking panel
            updateRankingPanel('quarterly', practices, data);
        })
        .catch(error => {
            console.error('Error loading quarterly practices chart:', error);
            createEmptyChart(ctx, 'Quarterly Practices - Error Loading Data');
        });
}

// Create Empty Chart for fallback
function createEmptyChart(ctx, title) {
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['No Data'],
            datasets: [{
                label: 'No Data',
                data: [0],
                backgroundColor: '#e9ecef',
                borderColor: '#adb5bd',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    max: 100,
                    ticks: { font: { size: 10 } }
                },
                y: {
                    ticks: { font: { size: 9 } }
                }
            },
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: title,
                    font: { size: 12, weight: 'bold' },
                    color: '#6c757d'
                }
            }
        }
    });
}

// Update Ranking Panel
function updateRankingPanel(type, practices, data) {
    const rankingList = document.getElementById(type + 'RankingList');
    if (!rankingList) return;
    
    let html = '';
    practices.slice(0, 5).forEach((practice, index) => {
        const [practiceText, stats] = practice;
        const totalUsers = stats.total;
        const percentage = practices.reduce((sum, [, s]) => sum + s.total, 0) > 0 ? 
            ((totalUsers / practices.reduce((sum, [, s]) => sum + s.total, 0)) * 100).toFixed(1) : 0;
        
        // Determine impact level based on HIGH/MEDIUM/LOW distribution
        let impactLevel = 'MEDIUM';
        let impactColor = '#ffc107';
        
        if (stats.HIGH > stats.MEDIUM && stats.HIGH > stats.LOW) {
            impactLevel = 'HIGH';
            impactColor = '#28a745';
        } else if (stats.LOW > stats.HIGH && stats.LOW > stats.MEDIUM) {
            impactLevel = 'LOW';
            impactColor = '#dc3545';
        }
        
        html += `
            <div class="ranking-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <div class="d-flex align-items-center">
                    <span class="ranking-number me-2 fw-bold text-muted">#${index + 1}</span>
                    <div>
                        <div class="practice-name fw-bold" style="font-size: 0.9rem;">${practiceText.length > 25 ? practiceText.substring(0, 25) + '...' : practiceText}</div>
                        <div class="text-muted" style="font-size: 0.8rem;">
                            <span class="badge" style="background-color: ${impactColor}; color: white;">${impactLevel}</span>
                        </div>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold">${percentage}%</div>
                    <div class="text-muted" style="font-size: 0.8rem;">${totalUsers} users</div>
                </div>
            </div>
        `;
    });
    
    rankingList.innerHTML = html;
}



// Create User Table Row (legacy support)
function createUserTableRow(user, practice, type) {
    const impactLevel = practice.impact_level || 'MEDIUM';
    const impactBadge = getImpactBadge(impactLevel);
    
    return `
        <tr>
            <td class="fw-bold">${user.name}</td>
            <td>${user.email}</td>
            <td>${practice.practice || 'Not specified'}</td>
            <td>${impactBadge}</td>
            <td>${practice.action_taken || 'Not specified'}</td>
            <td>${practice.what_worked || 'Not specified'}</td>
            <td>${practice.action_needed || 'Not specified'}</td>
        </tr>
    `;
}

// Get Impact Badge HTML
function getImpactBadge(level) {
    const badges = {
        'HIGH': '<span class="badge bg-success">HIGH</span>',
        'MEDIUM': '<span class="badge bg-warning">MEDIUM</span>',
        'LOW': '<span class="badge bg-danger">LOW</span>'
    };
    return badges[level] || badges['MEDIUM'];
}

// Load Practice Details Tables
function loadPracticeDetailsTables() {
    fetch('/admin/api/impact-analysis')
        .then(response => response.json())
        .then(data => {
            if (!data.practice_popularity) {
                console.warn('No practice popularity data available');
                return;
            }

            // Load weekly practices table
            loadPracticeTable('weekly', data.practice_popularity.weekly_practices, data);
            
            // Load monthly practices table
            loadPracticeTable('monthly', data.practice_popularity.monthly_practices, data);
            
            // Load quarterly practices table
            loadPracticeTable('quarterly', data.practice_popularity.quarterly_practices, data);
        })
        .catch(error => console.error('Error loading practice details:', error));
}

// Load individual practice table
function loadPracticeTable(type, practices, fullData) {
    const tableBody = document.getElementById(`${type}PracticesTableBody`);
    if (!tableBody || !practices) return;

    tableBody.innerHTML = '';

    // Sort practices by total usage
    const sortedPractices = Object.entries(practices)
        .filter(([practice, stats]) => practice !== 'Not specified' && stats.total > 0)
        .sort(([,a], [,b]) => b.total - a.total);

    sortedPractices.forEach(([practice, stats]) => {
        const successRate = ((stats.HIGH || 0) / stats.total * 100).toFixed(1);
        const row = document.createElement('tr');
        
        // Get survey responses for this practice
        const surveyResponses = getSurveyResponsesForPractice(practice, type, fullData);
        
        row.innerHTML = `
            <td>
                <div class="fw-bold">${practice}</div>
                <small class="text-muted">${type.charAt(0).toUpperCase() + type.slice(1)} Practice</small>
            </td>
            <td>
                <span class="badge bg-primary rounded-pill">${stats.total}</span>
            </td>
            <td>
                <div class="d-flex gap-1">
                    <span class="badge bg-success">${stats.HIGH || 0} HIGH</span>
                    <span class="badge bg-warning">${stats.MEDIUM || 0} MED</span>
                    <span class="badge bg-danger">${stats.LOW || 0} LOW</span>
                </div>
            </td>
            <td>
                <div class="survey-responses" style="max-height: 100px; overflow-y: auto;">
                    ${surveyResponses.map(response => `
                        <div class="mb-2 p-2 border rounded">
                            <strong>${response.user_name}</strong> - 
                            <span class="badge bg-${response.impact === 'HIGH' ? 'success' : response.impact === 'MEDIUM' ? 'warning' : 'danger'}">${response.impact}</span>
                            <br>
                            <small class="text-muted">${response.action_taken || 'No action specified'}</small>
                        </div>
                    `).join('')}
                </div>
            </td>
            <td>
                <div class="text-center">
                    <div class="fw-bold text-success">${successRate}%</div>
                    <div class="progress mt-1" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: ${(stats.HIGH || 0) / stats.total * 100}%"></div>
                        <div class="progress-bar bg-warning" style="width: ${(stats.MEDIUM || 0) / stats.total * 100}%"></div>
                        <div class="progress-bar bg-danger" style="width: ${(stats.LOW || 0) / stats.total * 100}%"></div>
                    </div>
                </div>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
}

// Get survey responses for a specific practice
function getSurveyResponsesForPractice(practice, type, fullData) {
    const responses = [];
    
    // Search through all impact levels
    ['high_impact', 'medium_impact', 'low_impact'].forEach(impactLevel => {
        const users = fullData[impactLevel] && fullData[impactLevel][type] ? fullData[impactLevel][type] : [];
        
        users.forEach(user => {
            if (user.pledge_data && user.pledge_data[`${type}_practice_1`] === practice) {
                const surveyKey = `${type}_practice_1`;
                const surveyResponse = user.survey_responses && user.survey_responses[surveyKey];
                
                if (surveyResponse) {
                    responses.push({
                        user_name: user.name,
                        impact: surveyResponse.impact,
                        action_taken: surveyResponse.response && surveyResponse.response.action_taken ? 
                                    surveyResponse.response.action_taken.substring(0, 50) + '...' : 'No action specified'
                    });
                }
            }
        });
    });
    
    return responses;
}

// Load Practice Impact Tables
function loadPracticeImpactTables() {
    console.log('Loading practice impact tables...');
    
    fetch('/admin/api/impact-analysis')
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}: Failed to fetch data`);
            return response.json();
        })
        .then(data => {
            console.log('Impact analysis data received:', data);
            
            // Ensure data structure exists
            if (!data.practice_popularity) {
                console.warn('practice_popularity not found in data');
                data.practice_popularity = { weekly_practices: {}, monthly_practices: {}, quarterly_practices: {} };
            }
            
            // Load Weekly Practices Table
            console.log('Loading weekly practices:', data.practice_popularity.weekly_practices);
            loadPracticeTable('weekly', data.practice_popularity.weekly_practices || {});
            
            // Load Monthly Practices Table  
            console.log('Loading monthly practices:', data.practice_popularity.monthly_practices);
            loadPracticeTable('monthly', data.practice_popularity.monthly_practices || {});
            
            // Load Quarterly Practices Table
            console.log('Loading quarterly practices:', data.practice_popularity.quarterly_practices);
            loadPracticeTable('quarterly', data.practice_popularity.quarterly_practices || {});
            
            showNotification('Practice impact tables loaded successfully!', 'success');
        })
        .catch(error => {
            console.error('Error loading practice impact tables:', error);
            showNotification('Error loading practice impact tables: ' + error.message, 'error');
            
            ['weekly', 'monthly', 'quarterly'].forEach(type => {
                const tableBody = document.getElementById(type + 'PracticeTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error loading ${type} practice data: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            });
        });
}

function loadPracticeTable(type, practices) {
    const tableBody = document.getElementById(type + 'PracticeTableBody');
    if (!tableBody) {
        console.log(`Table body not found for ${type}PracticeTableBody`);
        return;
    }
    
    let tableHTML = '';
    console.log(`Loading ${type} practices:`, practices);
    
    // Handle different data structures
    let practiceEntries = [];
    if (practices && typeof practices === 'object') {
        practiceEntries = Object.entries(practices)
            .filter(([practice, stats]) => {
                return practice && practice !== 'Not specified' && practice !== '' && 
                       stats && (stats.total > 0 || stats.high > 0 || stats.medium > 0 || stats.low > 0);
            })
            .sort(([,a], [,b]) => (b.total || 0) - (a.total || 0));
    }
    
    if (practiceEntries.length === 0) {
        // Show message for no data
        tableHTML = `
            <tr>
                <td colspan="5" class="text-center py-4">
                    <i class="fas fa-info-circle text-muted me-2"></i>
                    <span class="text-muted">No ${type} practice data available yet</span>
                </td>
            </tr>
        `;
    } else {
        practiceEntries.forEach(([practice, stats]) => {
            const highCount = stats.high || 0;
            const mediumCount = stats.medium || 0;
            const lowCount = stats.low || 0;
            const totalCount = stats.total || (highCount + mediumCount + lowCount);
            
            const highPercent = totalCount > 0 ? ((highCount/totalCount)*100).toFixed(1) : '0.0';
            const mediumPercent = totalCount > 0 ? ((mediumCount/totalCount)*100).toFixed(1) : '0.0';
            const lowPercent = totalCount > 0 ? ((lowCount/totalCount)*100).toFixed(1) : '0.0';
            
            tableHTML += `
                <tr>
                    <td class="fw-bold">${practice}</td>
                    <td class="text-center">
                        <span class="badge bg-success fs-6 px-3 py-2">${highCount}</span>
                        <br><small class="text-muted fw-bold">${highPercent}%</small>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning fs-6 px-3 py-2">${mediumCount}</span>
                        <br><small class="text-muted fw-bold">${mediumPercent}%</small>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-secondary fs-6 px-3 py-2">${lowCount}</span>
                        <br><small class="text-muted fw-bold">${lowPercent}%</small>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-info fs-6 px-3 py-2">${totalCount}</span>
                    </td>
                </tr>
            `;
        });
    }
    
    tableBody.innerHTML = tableHTML;
    console.log(`${type} table loaded with ${practiceEntries.length} practices`);
}

// Download individual chart functions
function downloadWeeklyChart() {
    showNotification('Generating weekly chart download...', 'info');
    const canvas = document.getElementById('weeklyPracticesChart');
    if (canvas) {
        const link = document.createElement('a');
        link.download = 'weekly_practices_chart.png';
        link.href = canvas.toDataURL();
        link.click();
        showNotification('Weekly chart downloaded successfully!', 'success');
    }
}

function downloadMonthlyChart() {
    showNotification('Generating monthly chart download...', 'info');
    const canvas = document.getElementById('monthlyPracticesChart');
    if (canvas) {
        const link = document.createElement('a');
        link.download = 'monthly_practices_chart.png';
        link.href = canvas.toDataURL();
        link.click();
        showNotification('Monthly chart downloaded successfully!', 'success');
    }
}

function downloadQuarterlyChart() {
    showNotification('Generating quarterly chart download...', 'info');
    const canvas = document.getElementById('quarterlyPracticesChart');
    if (canvas) {
        const link = document.createElement('a');
        link.download = 'quarterly_practices_chart.png';
        link.href = canvas.toDataURL();
        link.click();
        showNotification('Quarterly chart downloaded successfully!', 'success');
    }
}

// Download Impact Charts Function
function downloadImpactCharts() {
    showNotification('Generating chart images for download...', 'info');
    
    // Use the backend route to generate and download charts
    window.location.href = '/admin/download-impact-charts';
}

// Refresh Impact Data Function
function refreshImpactData() {
    showNotification('Refreshing impact analysis data...', 'info');
    
    // Re-initialize all charts
    setTimeout(() => {
        createImpactDistributionChart();
        createHighImpactChart();

        createWeeklyPracticesChart();
        createMonthlyPracticesChart();
        createQuarterlyPracticesChart();
        

        showNotification('Impact analysis data refreshed successfully!', 'success');
    }, 500);
}

// View User Impact Details Function
function viewUserImpactDetails(userId) {
    fetch(`/admin/participant/${userId}/impact-details`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('participantModalTitle').textContent = 'Impact Analysis Details';
            document.getElementById('participantModalBody').innerHTML = data.html;
            new bootstrap.Modal(document.getElementById('participantModal')).show();
        })
        .catch(error => {
            console.error('Error loading user impact details:', error);
            showNotification('Error loading user impact details', 'error');
        });
}

// Update main initialization to include impact analysis
document.addEventListener('DOMContentLoaded', function() {
    // Initialize impact analysis when tab is clicked
    document.addEventListener('shown.bs.tab', function (event) {
        if (event.target.id === 'impact-analysis-tab') {
            initializeImpactAnalysisCharts();
        }
    });
});

</script>

<style>
    /* Cohort Report Modal Styles */
    .cohort-filter-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .cohort-filter-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .report-type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .report-type-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .report-type-card:hover {
        border-color: #667eea;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        transform: translateY(-2px);
    }

    .report-type-card.selected {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .participant-selection {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
    }

    .participant-checkbox {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        transition: background-color 0.2s ease;
    }

    .participant-checkbox:hover {
        background-color: #f8f9fa;
    }
</style>

{% endblock %}
